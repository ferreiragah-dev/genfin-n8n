<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>GenFin | Painel Financeiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

/* === DARK FINTECH THEME === */
:root{
  --bg:#05070d;
  --bg-grad: radial-gradient(circle at top, #0a1020, #02030a 65%);
  --panel:#0b1224;
  --panel2:#0f1630;
  --border:rgba(56,189,248,.15);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --red:#ef4444;
  --blue:#38bdf8;
  --purple:#7c3aed;
  --pink:#db2777;
  --yellow:#eab308;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background: var(--bg-grad);
  color:var(--text);
}

.container{
  padding:20px;
  display:grid;
  grid-template-rows:auto 1fr;
  gap:20px;
}

/* HEADER */
.header{
  background:linear-gradient(180deg, #0b1224, #070b18);
  border-radius:16px;
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border:1px solid var(--border);
}

.user{display:flex;align-items:center;gap:12px;}
.avatar{
  width:42px;height:42px;border-radius:12px;
  background:linear-gradient(135deg,#0b1224,#020617);
  display:flex;align-items:center;justify-content:center;
  font-weight:700;color:#38bdf8;
  border:1px solid rgba(56,189,248,.25);
}

/* GRID */
.grid{display:grid;grid-template-columns:1fr;gap:20px;}
.left{display:grid;gap:20px;}

/* PAINEL PADRÃƒO */
.panel{
  background:linear-gradient(180deg,#070b18,#020617);
  border-radius:18px;
  padding:18px;
  border:1px solid var(--border);
}

.panel h3{
  margin:0 0 12px;
  font-size:13px;
  color:#94a3b8;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.panel-compact{
  padding: 12px;
}

.panel-compact canvas{
  max-height: 140px;
}

/* CARDS PRINCIPAIS */
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.card{
  background:linear-gradient(180deg,#0b1224,#020617);
  border-radius:16px;
  padding:18px;
  border:1px solid var(--border);
}
.card span{color:var(--muted);font-size:12px;}
.card strong{font-size:22px;display:block;margin-top:6px;}
.green{color:var(--green)} .red{color:var(--red)} .yellow{color:var(--yellow)} .blue{color:var(--blue)}

/* RESUMO NEON DARK */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;}
.stat-card{
  background:linear-gradient(180deg,#060b1a,#020617);
  border-radius:18px;
  padding:18px;
  border:1px solid rgba(56,189,248,.12);
  box-shadow:0 0 18px rgba(56,189,248,.08);
  transition:.25s;
}
.stat-card:hover{
  transform:translateY(-3px);
  box-shadow:0 0 28px rgba(56,189,248,.18);
}
.stat-card h4{
  margin:0 0 12px;
  color:#38bdf8;
  letter-spacing:.08em;
  text-transform:uppercase;
  font-size:11px;
}
.metric{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px dashed rgba(255,255,255,.06);
  font-size:12px;
}
.metric b{font-size:13px;}
.stat-card canvas{margin-top:12px;max-height:120px}

/* GAUGES */
.gauges{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.gauge{
  background:linear-gradient(180deg,#0b1224,#020617);
  border-radius:14px;
  padding:12px;
  text-align:center;
  border:1px solid var(--border);
}
.gauge canvas{max-height:90px}

/* BARRAS */
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:12px;color:#9ca3af;}
.bar-bg{flex:1;height:8px;background:#020617;border-radius:10px;overflow:hidden;}
.bar-fill{height:100%;background:linear-gradient(90deg,#7c3aed,#db2777);}

@media(max-width:1100px){
  .cards{grid-template-columns:1fr 1fr}
}
</style>

<script>
async function load(){
  function parseBrDate(value){
    const parts = String(value || "").split("/");
    if(parts.length !== 3) return null;
    const day = Number(parts[0]);
    const month = Number(parts[1]) - 1;
    const year = Number(parts[2]);
    const date = new Date(year, month, day);
    if(Number.isNaN(date.getTime())) return null;
    return date;
  }
  function formatCurrency(value){
    return "R$ " + Number(value || 0).toLocaleString("pt-BR", {minimumFractionDigits:2, maximumFractionDigits:2});
  }
  async function fetchJson(url){
    const response = await fetch(url, {credentials:"same-origin"});
    if(!response.ok){
      throw new Error(`Falha em ${url}: ${response.status}`);
    }
    return response.json();
  }
  try{
    const [dash, entries, cats, daily, weekly, monthly] = await Promise.all([
      fetchJson("/api/dashboard/"),
      fetchJson("/api/entries/"),
      fetchJson("/api/dashboard/categories/"),
      fetchJson("/api/stats/daily/"),
      fetchJson("/api/stats/weekly/"),
      fetchJson("/api/stats/monthly/")
    ]);
    document.getElementById("receita").innerText = formatCurrency(dash.total_receita);
    document.getElementById("despesa").innerText = formatCurrency(dash.total_despesa);
    document.getElementById("saldo").innerText = formatCurrency(dash.saldo);
    document.getElementById("movimentacoes").innerText = entries.length;
    const hoje = new Date();
    const diaDoMes = hoje.getDate();
    const diasNoMes = new Date(hoje.getFullYear(), hoje.getMonth()+1, 0).getDate();
    const taxaPoupanca = dash.total_receita > 0
      ? Math.round((dash.saldo / dash.total_receita) * 100)
      : 0;
    const burnRate = dash.total_despesa / Math.max(diaDoMes,1);
    const despesaProjetada = burnRate * diasNoMes;
    const saldoProjetado = dash.total_receita - despesaProjetada;
    document.getElementById("taxa_poupanca").innerText = taxaPoupanca + "%";
    document.getElementById("burn_rate").innerText = formatCurrency(burnRate);
    document.getElementById("projecao_fim_mes").innerText = formatCurrency(saldoProjetado);
    const weekMap = {0:0,1:0,2:0,3:0,4:0,5:0,6:0};
    entries.forEach(e=>{
      if(e.entry_type === "DESPESA"){
        const d = parseBrDate(e.date);
        if(d) weekMap[d.getDay()] += Number(e.amount) || 0;
      }
    });
    new Chart(document.getElementById("heatmapWeek"),{
      type:"bar",
      data:{
        labels:["Dom","Seg","Ter","Qua","Qui","Sex","Sab"],
        datasets:[{ data:Object.values(weekMap), backgroundColor:"#ef4444" }]
      },
      options:{ plugins:{ legend:{display:false} } }
    });
    const top5 = entries
      .filter(e=>e.entry_type==="DESPESA")
      .sort((a,b)=>Number(b.amount)-Number(a.amount))
      .slice(0,5);
    const max = Math.max(...top5.map(e=>Number(e.amount) || 0),1);
    const topBox = document.getElementById("top5");
    topBox.textContent = "";
    top5.forEach(e=>{
      const row = document.createElement("div");
      row.className = "bar-row";
      const label = document.createElement("span");
      label.textContent = `${e.category} (${formatCurrency(e.amount)})`;
      const barBg = document.createElement("div");
      barBg.className = "bar-bg";
      const barFill = document.createElement("div");
      barFill.className = "bar-fill";
      barFill.style.width = `${((Number(e.amount) || 0)/max)*100}%`;
      barBg.appendChild(barFill);
      row.appendChild(label);
      row.appendChild(barBg);
      topBox.appendChild(row);
    });
    function render(prefix, data, chartId){
      document.getElementById(prefix+"_in").innerText = formatCurrency(data.total_receita);
      document.getElementById(prefix+"_out").innerText = formatCurrency(data.total_despesa);
      document.getElementById(prefix+"_mov").innerText = data.movimentacoes;
      document.getElementById(prefix+"_in_p").innerText = data.percent_receita + "%";
      document.getElementById(prefix+"_out_p").innerText = data.percent_despesa + "%";
      new Chart(document.getElementById(chartId),{
        type:"bar",
        data:{ labels:["Entradas","Saidas"], datasets:[{ data:[data.total_receita, data.total_despesa], backgroundColor:["#22c55e","#ef4444"] }] },
        options:{ plugins:{ legend:{display:false} } }
      });
    }
    render("d", daily, "chartDaily");
    render("w", weekly, "chartWeekly");
    render("m", monthly, "chartMonthly");
    const centerTextPlugin = {
      id: "centerText",
      beforeDraw(chart) {
        const { ctx, chartArea } = chart;
        if (!chartArea) return;
        const pct = chart.config.data.datasets[0].data[0];
        const val = chart.config.data._valor || 0;
        const x = (chartArea.left + chartArea.right) / 2;
        const y = (chartArea.top + chartArea.bottom) / 2;
        ctx.save();
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = "600 14px Inter";
        ctx.fillStyle = "#e5e7eb";
        ctx.fillText(pct + "%", x, y - 6);
        ctx.font = "400 11px Inter";
        ctx.fillStyle = "#9ca3af";
        ctx.fillText("R$ " + Number(val).toLocaleString("pt-BR"), x, y + 10);
        ctx.restore();
      }
    };
    const totalDespesa = cats.reduce((sum,c)=>sum + Number(c.total || 0), 0);
    cats.slice(0,4).forEach((c, i)=>{
      const pct = totalDespesa > 0
        ? Math.round((Number(c.total || 0) / totalDespesa) * 100)
        : 0;
      const chartData = {
        labels:["Despesa","Restante"],
        datasets:[{
          data:[pct, 100-pct],
          backgroundColor:["#ef4444","#1e293b"],
          borderWidth:0
        }],
        _valor: c.total
      };
      new Chart(document.getElementById("g"+(i+1)),{
        type:"doughnut",
        plugins:[centerTextPlugin],
        data: chartData,
        options:{
          cutout:"70%",
          plugins:{legend:{display:false}, tooltip:{enabled:false}}
        }
      });
      document.querySelectorAll(".gauge small")[i].innerText = c.category;
    });

    let fixedExpenses = [];
    try{
      fixedExpenses = await fetchJson("/api/planner/");
    } catch (plannerError){
      console.error("Falha ao carregar despesas fixas:", plannerError);
    }

    const fixedByCategory = {};
    fixedExpenses.filter((item)=>item.is_recurring).forEach((item)=>{
      const category = item.category || "Sem categoria";
      fixedByCategory[category] = (fixedByCategory[category] || 0) + Number(item.amount || 0);
    });

    const fixedTop = Object.entries(fixedByCategory)
      .map(([category, total])=>({category, total}))
      .sort((a,b)=>b.total - a.total)
      .slice(0,4);

    const totalFixed = fixedTop.reduce((sum, item)=>sum + item.total, 0);
    fixedTop.forEach((item, i)=>{
      const pct = totalFixed > 0 ? Math.round((item.total / totalFixed) * 100) : 0;
      const chartData = {
        labels:["Despesa Fixa","Restante"],
        datasets:[{
          data:[pct, 100-pct],
          backgroundColor:["#38bdf8","#1e293b"],
          borderWidth:0
        }],
        _valor: item.total
      };

      new Chart(document.getElementById("fg"+(i+1)),{
        type:"doughnut",
        plugins:[centerTextPlugin],
        data: chartData,
        options:{
          cutout:"70%",
          plugins:{legend:{display:false}, tooltip:{enabled:false}}
        }
      });
      document.querySelectorAll(".fixed-gauge small")[i].innerText = item.category;
    });
  } catch (error){
    console.error(error);
    document.getElementById("top5").textContent = "Erro ao carregar dados do dashboard.";
  }
}
load();
</script>
</head>

<body>

<div class="container">

  <div class="header">
    <div class="user">
      <div class="avatar">GF</div>
      <div>
        <strong>GenFin</strong><br>
        <small style="color:#94a3b8">Painel Financeiro</small>
      </div>
    </div>
    <a href="/fixed-expenses/" style="color:#94a3b8;text-decoration:none">Despesas Fixas</a>
  </div>

  <div class="grid">

    <div class="left">

      <div class="cards">
        <div class="card"><span>Receitas</span><strong class="green" id="receita">R$ 0</strong></div>
        <div class="card"><span>Despesas</span><strong class="red" id="despesa">R$ 0</strong></div>
        <div class="card"><span>Saldo Atual</span><strong class="yellow" id="saldo">R$ 0</strong></div>
        <a class="card" href="/transactions/" style="text-decoration:none;color:inherit;cursor:pointer">
          <span>Movimentacoes</span><strong class="blue" id="movimentacoes">--</strong>
        </a>
      </div>

      <!-- NOVOS CARDS -->
      <div class="cards">
        <div class="card"><span>Taxa de PoupanÃ§a</span><strong class="green" id="taxa_poupanca">0%</strong></div>
        <div class="card"><span>Burn Rate (R$/dia)</span><strong class="red" id="burn_rate">R$ 0</strong></div>
        <div class="card"><span>ProjeÃ§Ã£o Fim do MÃªs</span><strong class="yellow" id="projecao_fim_mes">R$ 0</strong></div>
        <div class="card"><span>â€”</span><strong class="blue">â€”</strong></div>
      </div>

      <div class="panel">
        <h3>Resumo de MovimentaÃ§Ãµes</h3>
        <div class="stats">
          <div class="stat-card">
            <h4>Hoje</h4>
            <div class="metric">Entrou: <b id="d_in">R$ 0</b></div>
            <div class="metric">Saiu: <b id="d_out">R$ 0</b></div>
            <div class="metric">MovimentaÃ§Ãµes: <b id="d_mov">0</b></div>
            <div class="metric">Entrada %: <b id="d_in_p">0%</b></div>
            <div class="metric">SaÃ­da %: <b id="d_out_p">0%</b></div>
            <canvas id="chartDaily"></canvas>
          </div>

          <div class="stat-card">
            <h4>Ãšltimos 7 dias</h4>
            <div class="metric">Entrou: <b id="w_in">R$ 0</b></div>
            <div class="metric">Saiu: <b id="w_out">R$ 0</b></div>
            <div class="metric">MovimentaÃ§Ãµes: <b id="w_mov">0</b></div>
            <div class="metric">Entrada %: <b id="w_in_p">0%</b></div>
            <div class="metric">SaÃ­da %: <b id="w_out_p">0%</b></div>
            <canvas id="chartWeekly"></canvas>
          </div>

          <div class="stat-card">
            <h4>Ãšltimos 30 dias</h4>
            <div class="metric">Entrou: <b id="m_in">R$ 0</b></div>
            <div class="metric">Saiu: <b id="m_out">R$ 0</b></div>
            <div class="metric">MovimentaÃ§Ãµes: <b id="m_mov">0</b></div>
            <div class="metric">Entrada %: <b id="m_in_p">0%</b></div>
            <div class="metric">SaÃ­da %: <b id="m_out_p">0%</b></div>
            <canvas id="chartMonthly"></canvas>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Desempenho por Categoria (% da Despesa)</h3>
        <div class="gauges">
          <div class="gauge"><canvas id="g1"></canvas><small>â€”</small></div>
          <div class="gauge"><canvas id="g2"></canvas><small>â€”</small></div>
          <div class="gauge"><canvas id="g3"></canvas><small>â€”</small></div>
          <div class="gauge"><canvas id="g4"></canvas><small>â€”</small></div>
        </div>
      </div>

      <div class="panel">
        <h3>Desempenho por Despesas Fixas (% do Planejado)</h3>
        <div class="gauges">
          <div class="gauge fixed-gauge"><canvas id="fg1"></canvas><small>â€”</small></div>
          <div class="gauge fixed-gauge"><canvas id="fg2"></canvas><small>â€”</small></div>
          <div class="gauge fixed-gauge"><canvas id="fg3"></canvas><small>â€”</small></div>
          <div class="gauge fixed-gauge"><canvas id="fg4"></canvas><small>â€”</small></div>
        </div>
      </div>

<div class="panel panel-compact">
  <h3>Gastos por Dia da Semana</h3>
  <canvas id="heatmapWeek"></canvas>
</div>

<div class="panel">
  <h3>Top 5 Maiores Gastos</h3>
  <div id="top5"></div>
</div>


    </div>

  </div>
</div>
</body>
</html>

