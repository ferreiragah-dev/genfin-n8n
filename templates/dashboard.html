<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>GenFin | Seu Painel Financeiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

/* === DARK FINTECH THEME === */
:root{
  --bg:#05070d;
  --bg-grad: radial-gradient(circle at top, #0a1020, #02030a 65%);
  --panel:#0b1224;
  --panel2:#0f1630;
  --border:rgba(56,189,248,.15);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --red:#ef4444;
  --blue:#38bdf8;
  --purple:#7c3aed;
  --pink:#db2777;
  --yellow:#eab308;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background: var(--bg-grad);
  color:var(--text);
}
.app-shell{
  display:grid;
  grid-template-columns:220px 1fr;
  gap:14px;
  min-height:100vh;
  padding:14px;
}
.sidebar{
  background:linear-gradient(180deg,#0b1224,#070b18);
  border:1px solid var(--border);
  border-radius:16px;
  padding:14px;
  display:grid;
  align-content:start;
  gap:10px;
}
.sidebar h4{
  margin:2px 0 8px;
  color:#94a3b8;
  font-size:12px;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.side-link{
  text-decoration:none;
  color:#cbd5e1;
  border:1px solid rgba(56,189,248,.2);
  background:linear-gradient(180deg,#0b1224,#020617);
  border-radius:12px;
  padding:10px 12px;
  font-size:13px;
}
.side-link:hover{filter:brightness(1.08)}

.container{
  padding:20px;
  display:grid;
  grid-template-rows:auto 1fr;
  gap:20px;
}

/* HEADER */
.header{
  background:linear-gradient(180deg, #0b1224, #070b18);
  border-radius:16px;
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border:1px solid var(--border);
}
.header-actions{display:flex;align-items:center;gap:14px}
.header-links{display:flex;gap:14px}
.icon-link{
  width:36px;height:36px;border-radius:10px;border:1px solid var(--border);
  background:linear-gradient(180deg,#0b1224,#020617);color:#cbd5e1;cursor:pointer;
  display:flex;align-items:center;justify-content:center;text-decoration:none;
}
.icon-link.logout{color:#fecaca;border-color:rgba(239,68,68,.35)}
.icon-link.pdf{color:#bfdbfe;border-color:rgba(56,189,248,.35)}
.icon-link.whatsapp{color:#86efac;border-color:rgba(34,197,94,.35)}
.theme-switch{
  display:flex;align-items:center;gap:4px;
  border:1px solid var(--border);
  border-radius:999px;
  padding:3px;
  background:linear-gradient(180deg,#0b1224,#020617);
}
.theme-btn{
  border:0;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
  background:transparent;
  color:#cbd5e1;
}
.theme-btn.active{
  background:#38bdf8;
  color:#04111d;
}
.visibility-btn{
  width:36px;height:36px;border-radius:10px;border:1px solid var(--border);
  background:linear-gradient(180deg,#0b1224,#020617);color:#cbd5e1;cursor:pointer;
}
.visibility-btn.active{border-color:rgba(234,179,8,.55);color:#fde68a}
.notif-wrap{position:relative}
.notif-btn{
  width:36px;height:36px;border-radius:10px;border:1px solid var(--border);
  background:linear-gradient(180deg,#0b1224,#020617);color:#cbd5e1;cursor:pointer;
}
.notif-badge{
  position:absolute;top:-6px;right:-6px;min-width:18px;height:18px;border-radius:10px;
  background:#ef4444;color:#fff;font-size:11px;display:flex;align-items:center;justify-content:center;padding:0 5px;
}
.notif-panel{
  position:absolute;top:42px;right:0;width:320px;max-height:260px;overflow:auto;z-index:20;
  background:linear-gradient(180deg,#0b1224,#020617);border:1px solid var(--border);border-radius:12px;padding:10px;display:none;
}
.notif-panel.open{display:block}
.notif-item{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);font-size:12px}
.notif-item:last-child{border-bottom:0}
.notif-empty{font-size:12px;color:#94a3b8;padding:8px}
.notif-item.smart{border-left:2px solid #38bdf8;padding-left:10px}
.month-bar{
  display:flex;gap:8px;overflow:auto;padding-bottom:4px;
}
.month-chip{
  border:1px solid var(--border);
  background:#0b1224;
  color:#cbd5e1;
  border-radius:999px;
  padding:7px 12px;
  font-size:12px;
  cursor:pointer;
  white-space:nowrap;
}
.month-chip.active{background:#38bdf8;color:#04111d}

.user{display:flex;align-items:center;gap:12px;}
.avatar{
  width:42px;height:42px;border-radius:12px;
  background:linear-gradient(135deg,#0b1224,#020617);
  display:flex;align-items:center;justify-content:center;
  font-weight:700;color:#38bdf8;
  border:1px solid rgba(56,189,248,.25);
}

/* GRID */
.grid{display:grid;grid-template-columns:1fr;gap:20px;}
.left{display:grid;gap:20px;}

/* PAINEL PADRÃO */
.panel{
  background:linear-gradient(180deg,#070b18,#020617);
  border-radius:18px;
  padding:18px;
  border:1px solid var(--border);
}

.panel h3{
  margin:0 0 12px;
  font-size:13px;
  color:#94a3b8;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.panel-compact{
  padding: 12px;
}

.panel-compact canvas{
  max-height: 140px;
}

/* CARDS PRINCIPAIS */
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;align-items:start}
.cards-top{grid-template-columns:repeat(3,1fr);}
.card{
  background:linear-gradient(180deg,#0b1224,#020617);
  border-radius:16px;
  padding:14px;
  border:1px solid var(--border);
}
.card-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.card-icon-btn{
  width:28px;height:28px;border-radius:9px;border:1px solid rgba(56,189,248,.35);
  background:#0b1224;color:#cbd5e1;font-size:16px;line-height:1;cursor:pointer;
}
.card-icon-btn:hover{filter:brightness(1.15)}
.card-icon-btn.minus{border-color:rgba(239,68,68,.45);color:#fecaca}
.card span{color:var(--muted);font-size:12px;}
.card strong{font-size:20px;display:block;margin-top:6px;}
.green{color:var(--green)} .red{color:var(--red)} .yellow{color:var(--yellow)} .blue{color:var(--blue)}
.card-donut canvas{max-height:92px}
.card-donut small{display:block;margin-top:6px;color:#94a3b8;font-size:11px}

/* RESUMO NEON DARK */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;}
.stat-card{
  background:linear-gradient(180deg,#060b1a,#020617);
  border-radius:18px;
  padding:18px;
  border:1px solid rgba(56,189,248,.12);
  box-shadow:0 0 18px rgba(56,189,248,.08);
  transition:.25s;
}
.stat-card:hover{
  transform:translateY(-3px);
  box-shadow:0 0 28px rgba(56,189,248,.18);
}
.stat-card h4{
  margin:0 0 12px;
  color:#38bdf8;
  letter-spacing:.08em;
  text-transform:uppercase;
  font-size:11px;
}
.metric{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px dashed rgba(255,255,255,.06);
  font-size:12px;
}
.metric b{font-size:13px;}
.stat-card canvas{margin-top:12px;max-height:120px}

/* GAUGES */
.gauges{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.gauge{
  background:linear-gradient(180deg,#0b1224,#020617);
  border-radius:14px;
  padding:12px;
  text-align:center;
  border:1px solid var(--border);
}
.gauge canvas{max-height:90px}

/* BARRAS */
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:12px;color:#9ca3af;}
.bar-bg{flex:1;height:8px;background:#020617;border-radius:10px;overflow:hidden;}
.bar-fill{height:100%;background:linear-gradient(90deg,#7c3aed,#db2777);}
.section-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.panel-head{display:flex;justify-content:space-between;align-items:center;gap:10px}
.panel-head h3{margin:0}
.panel-body{margin-top:12px}
.panel-toggle{
  width:30px;height:30px;border-radius:9px;border:1px solid var(--border);
  background:#0b1224;color:#cbd5e1;cursor:pointer;font-size:14px;line-height:1;
}
.panel-toggle:hover{filter:brightness(1.12)}
.panel.collapsed .panel-body{display:none}
.panel.collapsed .panel-toggle{transform:rotate(-90deg)}
.period-filters{display:flex;gap:8px}
.period-btn{
  border:1px solid var(--border);
  background:#0b1224;
  color:#cbd5e1;
  border-radius:10px;
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
}
.period-btn.active{background:#38bdf8;color:#04111d}
.intel-grid{display:grid;grid-template-columns:1.3fr 1fr;gap:16px}
.intel-left,.intel-right{display:grid;gap:12px}
.intel-left{align-content:start}
.intel-right{grid-template-columns:repeat(2,minmax(0,1fr));align-content:start}
.mini-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;align-items:start}
.mini-card{
  background:linear-gradient(180deg,#0b1224,#020617);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
}
.intel-left .mini-cards .mini-card{min-height:104px}
.mini-card-link{
  color:inherit;
  text-decoration:none;
  display:block;
}
.mini-card h5{margin:0;color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:.06em}
.mini-card strong{display:block;margin-top:6px;font-size:20px}
.mini-card.card-donut canvas{max-height:110px}
.mini-card.card-donut small{display:block;margin-top:6px;color:#94a3b8;font-size:11px}
.trend{font-size:12px;margin-top:4px}
.trend.up{color:#22c55e}
.trend.down{color:#ef4444}
.trend.flat{color:#eab308}
.badges{display:flex;flex-wrap:wrap;gap:8px}
.badge{
  border-radius:999px;
  border:1px solid rgba(56,189,248,.25);
  padding:6px 10px;
  font-size:12px;
  color:#cbd5e1;
  background:rgba(56,189,248,.08);
}
.badge.warn{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.12)}
.insight-box{
  background:linear-gradient(180deg,#0b1224,#020617);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  font-size:13px;
  color:#cbd5e1;
  line-height:1.4;
}
.insight-box p{margin:0 0 8px}
.insight-box p:last-child{margin:0}
.eff-grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
.eff-metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.eff-item{
  background:linear-gradient(180deg,#0b1224,#020617);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
}
.eff-item h6{margin:0;color:#94a3b8;font-size:11px;letter-spacing:.06em;text-transform:uppercase}
.eff-item strong{display:block;margin-top:6px;font-size:18px;color:#e2e8f0}
.eff-charts{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;align-items:start}
.eff-card{
  background:linear-gradient(180deg,#0b1224,#020617);
  border:1px solid var(--border);
  border-radius:12px;
  padding:9px;
}
.eff-card h6{margin:0 0 8px;color:#94a3b8;font-size:11px;letter-spacing:.06em;text-transform:uppercase}
.eff-card canvas{max-height:140px}
.risk-grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
.risk-metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.risk-item{
  background:linear-gradient(180deg,#0b1224,#020617);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
}
.risk-item h6{margin:0;color:#94a3b8;font-size:11px;letter-spacing:.06em;text-transform:uppercase}
.risk-item strong{display:block;margin-top:6px;font-size:18px;color:#e2e8f0}
.risk-charts{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;align-items:start}
.traffic{
  display:flex;align-items:center;gap:10px;padding:8px 0;
}
.traffic-dot{
  width:14px;height:14px;border-radius:50%;
  box-shadow:0 0 10px rgba(0,0,0,.35);
}
.traffic-dot.green{background:#22c55e}
.traffic-dot.yellow{background:#eab308}
.traffic-dot.red{background:#ef4444}
.traffic-label{font-size:12px;color:#cbd5e1}
.modal-overlay{
  position:fixed;inset:0;background:rgba(2,6,23,.75);backdrop-filter:blur(4px);
  display:none;align-items:center;justify-content:center;z-index:80;padding:16px;
}
.modal-overlay.open{display:flex}
.modal{
  width:min(520px,96vw);
  background:linear-gradient(180deg,#0b1224,#020617);
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:0 20px 50px rgba(2,6,23,.45);
  overflow:hidden;
}
.modal-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-bottom:1px solid rgba(148,163,184,.18);
}
.modal-head h4{margin:0;color:#e2e8f0;font-size:15px}
.modal-close{
  width:30px;height:30px;border-radius:9px;border:1px solid rgba(148,163,184,.25);
  background:#0b1224;color:#cbd5e1;cursor:pointer;
}
.modal-body{padding:16px;display:grid;gap:12px}
.field label{display:block;font-size:12px;color:#94a3b8;margin-bottom:6px}
.field input,.field textarea{
  width:100%;border-radius:10px;border:1px solid rgba(56,189,248,.22);
  background:#0b1224;color:#e5e7eb;padding:10px;font:inherit;
}
.field textarea{resize:vertical;min-height:80px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:6px}
.modal-btn{
  border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;
}
.modal-btn.primary{background:#38bdf8;color:#04111d}
.modal-btn.secondary{background:#1e293b;color:#cbd5e1}
.modal-message{font-size:12px;min-height:16px;color:#22c55e}
body.values-hidden .card strong,
body.values-hidden .mini-card strong,
body.values-hidden .mini-card small,
body.values-hidden .eff-item strong,
body.values-hidden .risk-item strong,
body.values-hidden .metric b,
body.values-hidden .trend,
body.values-hidden .bar-row span,
body.values-hidden .insight-box,
body.values-hidden .notif-item,
body.values-hidden .gauge small,
body.values-hidden .fixed-gauge small{
  filter:blur(6px);
  user-select:none;
}
body.values-hidden canvas{
  filter:blur(6px);
}

body.theme-light{
  --bg:#f3f7ff;
  --bg-grad: radial-gradient(circle at top, #ffffff, #eef4ff 68%);
  --border:rgba(30,64,175,.16);
  --text:#0f172a;
  --muted:#475569;
  --blue:#2563eb;
  --green:#16a34a;
  --red:#dc2626;
  --yellow:#ca8a04;
}
body.theme-light .header{
  background:linear-gradient(180deg,#ffffff,#f5f9ff);
}
body.theme-light .sidebar,
body.theme-light .side-link{
  background:linear-gradient(180deg,#ffffff,#f8fbff);
  color:#0f172a;
}
body.theme-light .sidebar h4{color:#334155}
body.theme-light .panel,
body.theme-light .card,
body.theme-light .stat-card,
body.theme-light .mini-card,
body.theme-light .eff-item,
body.theme-light .risk-item,
body.theme-light .eff-card,
body.theme-light .gauge,
body.theme-light .month-chip,
body.theme-light .period-btn,
body.theme-light .notif-panel,
body.theme-light .modal,
body.theme-light .notif-btn,
body.theme-light .card-icon-btn,
body.theme-light .visibility-btn,
body.theme-light .theme-switch,
body.theme-light .modal-close,
body.theme-light .panel-toggle,
body.theme-light .theme-btn{
  background:linear-gradient(180deg,#ffffff,#f8fbff);
  color:#0f172a;
}
body.theme-light .avatar{
  background:linear-gradient(135deg,#e2ebff,#f8fbff);
  color:#2563eb;
}
body.theme-light .panel h3,
body.theme-light .mini-card h5,
body.theme-light .eff-card h6,
body.theme-light .eff-item h6,
body.theme-light .risk-item h6,
body.theme-light .stat-card h4,
body.theme-light .metric,
body.theme-light small,
body.theme-light .trend.flat,
body.theme-light .traffic-label{
  color:#334155;
}
body.theme-light .month-chip.active,
body.theme-light .period-btn.active,
body.theme-light .theme-btn.active{
  background:#2563eb;
  color:#ffffff;
}
body.theme-light .insight-box,
body.theme-light .field input,
body.theme-light .field textarea{
  background:#f8fbff;
  color:#0f172a;
}
body.theme-light .header-links a{color:#334155 !important}
body.theme-light .icon-link{
  background:linear-gradient(180deg,#ffffff,#f8fbff);
  color:#0f172a;
}
body.theme-light .icon-link.logout{color:#dc2626}
body.theme-light .user small{color:#475569 !important}
body.theme-light #selectedMonthLabel{color:#475569 !important}
body.theme-light .bar-bg{background:#dbe7ff}
body.theme-light .badge{color:#1e293b;background:rgba(37,99,235,.1);border-color:rgba(37,99,235,.25)}
body.theme-light .badge.warn{color:#7f1d1d;background:rgba(220,38,38,.12);border-color:rgba(220,38,38,.32)}
body.theme-light .notif-item{color:#1e293b}

@media(max-width:1100px){
  .cards{grid-template-columns:1fr 1fr}
  .mini-cards{grid-template-columns:1fr}
  .intel-grid{grid-template-columns:1fr}
  .intel-right{grid-template-columns:1fr}
  .eff-grid{grid-template-columns:1fr}
  .eff-metrics{grid-template-columns:1fr}
  .eff-charts{grid-template-columns:1fr}
  .risk-grid{grid-template-columns:1fr}
  .risk-metrics{grid-template-columns:1fr}
  .risk-charts{grid-template-columns:1fr}
}
@media(max-width:820px){
  .app-shell{
    grid-template-columns:1fr;
    padding:10px;
    gap:10px;
  }
  .sidebar{
    grid-auto-flow:column;
    grid-auto-columns:max-content;
    overflow:auto;
    align-content:center;
  }
  .sidebar h4{display:none}
  .container{padding:12px;gap:12px}
  .header{
    flex-direction:column;
    align-items:flex-start;
    gap:10px;
    padding:12px;
  }
  .header-actions{
    width:100%;
    justify-content:space-between;
    gap:10px;
  }
  .header-links{
    flex:1;
    min-width:0;
    display:flex;
    gap:10px;
    overflow:auto;
    white-space:nowrap;
    padding-bottom:2px;
  }
  .cards{grid-template-columns:1fr 1fr;gap:10px}
  .cards-top{grid-template-columns:1fr 1fr}
  .panel{padding:12px}
  .stats{grid-template-columns:1fr}
  .gauges{grid-template-columns:1fr 1fr}
  .notif-panel{
    right:0;
    width:min(92vw,320px);
    max-height:55vh;
  }
  .month-chip{padding:6px 10px;font-size:11px}
}
@media(max-width:560px){
  .avatar{width:36px;height:36px}
  .cards,.cards-top{grid-template-columns:1fr}
  .gauges{grid-template-columns:1fr}
  .card strong{font-size:18px}
  .metric{font-size:11px}
  .trend{font-size:11px}
  .header-links a{font-size:13px}
  .theme-btn{padding:5px 8px;font-size:11px}
  .visibility-btn,.notif-btn{width:32px;height:32px}
  .icon-link{width:32px;height:32px}
  .panel h3{font-size:12px}
}
</style>

<script>
async function load(){
  function parseBrDate(value){
    const parts = String(value || "").split("/");
    if(parts.length !== 3) return null;
    const day = Number(parts[0]);
    const month = Number(parts[1]) - 1;
    const year = Number(parts[2]);
    const date = new Date(year, month, day);
    if(Number.isNaN(date.getTime())) return null;
    return date;
  }
  function parseIsoDate(value){
    const parts = String(value || "").split("-");
    if(parts.length !== 3) return null;
    const year = Number(parts[0]);
    const month = Number(parts[1]) - 1;
    const day = Number(parts[2]);
    const date = new Date(year, month, day);
    if(Number.isNaN(date.getTime())) return null;
    return date;
  }
  function startOfDay(date){
    return new Date(date.getFullYear(), date.getMonth(), date.getDate());
  }
  function daysUntil(date){
    const ms = 24 * 60 * 60 * 1000;
    return Math.round((startOfDay(date) - startOfDay(new Date())) / ms);
  }
  function nextOccurrence(baseDate, recurring){
    const today = startOfDay(new Date());
    if(!baseDate) return null;
    if(!recurring){
      return baseDate >= today ? baseDate : null;
    }

    const day = baseDate.getDate();
    const buildDate = (year, month)=>{
      const lastDay = new Date(year, month + 1, 0).getDate();
      return new Date(year, month, Math.min(day, lastDay));
    };

    let candidate = buildDate(today.getFullYear(), today.getMonth());
    if(candidate < today){
      candidate = buildDate(today.getFullYear(), today.getMonth() + 1);
    }
    return candidate;
  }
  function renderNotifications(items){
    const badge = document.getElementById("notifBadge");
    const list = document.getElementById("notifList");
    const count = items.length;
    badge.style.display = count > 0 ? "flex" : "none";
    badge.textContent = String(count);
    list.textContent = "";
    if(count === 0){
      const empty = document.createElement("div");
      empty.className = "notif-empty";
      empty.textContent = "Sem vencimentos para os proximos 3 dias.";
      list.appendChild(empty);
      return;
    }
    items.forEach((item)=>{
      const div = document.createElement("div");
      div.className = item.smart ? "notif-item smart" : "notif-item";
      div.textContent = item.text || `${item.tipo}: ${item.categoria} (${formatCurrency(item.valor)}) em ${item.data} (${item.falta} dia(s))`;
      list.appendChild(div);
    });
  }
  function trendClass(value){
    if(value > 0) return "up";
    if(value < 0) return "down";
    return "flat";
  }
  function trendSymbol(value){
    if(value > 0) return "↑";
    if(value < 0) return "↓";
    return "→";
  }
  function clampPercent(value){
    return Math.max(0, Math.min(100, Math.round(value)));
  }
  function formatCurrency(value){
    return "R$ " + Number(value || 0).toLocaleString("pt-BR", {minimumFractionDigits:2, maximumFractionDigits:2});
  }
  function getCsrfToken(){
    const token = document.cookie
      .split("; ")
      .find((row)=>row.startsWith("csrftoken="));
    return token ? decodeURIComponent(token.split("=")[1]) : "";
  }
  function toBrDate(isoDate){
    const parts = String(isoDate || "").split("-");
    if(parts.length !== 3) return "";
    return `${parts[2]}/${parts[1]}/${parts[0]}`;
  }
  async function fetchJson(url){
    const response = await fetch(url, {credentials:"same-origin"});
    if(!response.ok){
      throw new Error(`Falha em ${url}: ${response.status}`);
    }
    return response.json();
  }
  try{
    const [dash, entries, cats] = await Promise.all([
      fetchJson("/api/dashboard/"),
      fetchJson("/api/entries/?limit=500"),
      fetchJson("/api/dashboard/categories/")
    ]);
    document.getElementById("receita").innerText = formatCurrency(dash.total_receita);
    document.getElementById("despesa").innerText = formatCurrency(dash.total_despesa);
    document.getElementById("saldo").innerText = formatCurrency(dash.saldo);
    document.getElementById("movimentacoes").innerText = entries.length;
    const webhookModeSwitch = document.getElementById("webhookModeSwitch");
    if(webhookModeSwitch){
      webhookModeSwitch.style.display = dash.phone_number === "5511913305093" ? "flex" : "none";
    }
    function initPdfExport(){
      const btn = document.getElementById("exportPdfBtn");
      if(!btn || btn.dataset.bound) return;
      btn.dataset.bound = "1";
      btn.addEventListener("click", async ()=>{
        if(!window.jspdf || !window.jspdf.jsPDF){
          alert("Ferramenta de PDF indisponível no momento.");
          return;
        }

        const originalText = btn.textContent;
        btn.textContent = "⏳";
        btn.style.pointerEvents = "none";

        try{
          const [dashPdf, entriesPdf, catsPdf, dailyPdf, weeklyPdf, monthlyPdf, fixedExpensesPdf, fixedIncomesPdf, reservesPdf] = await Promise.all([
            fetchJson("/api/dashboard/"),
            fetchJson("/api/entries/?limit=500"),
            fetchJson("/api/dashboard/categories/"),
            fetchJson("/api/stats/daily/"),
            fetchJson("/api/stats/weekly/"),
            fetchJson("/api/stats/monthly/"),
            fetchJson("/api/planner/").catch(()=>[]),
            fetchJson("/api/fixed-incomes/").catch(()=>[]),
            fetchJson("/api/reserves/").catch(()=>[]),
          ]);

          const monthNames = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
          const selectedMonthPdf = Number(document.querySelector(".month-chip.active")?.dataset.month ?? new Date().getMonth());
          const selectedYearPdf = new Date().getFullYear();

          const entriesParsedPdf = entriesPdf.map((e)=>({
            ...e,
            amountNumber: Number(e.amount || 0),
            parsedDate: parseBrDate(e.date),
          }));
          const monthEntriesPdf = entriesParsedPdf.filter((e)=>e.parsedDate && e.parsedDate.getFullYear() === selectedYearPdf && e.parsedDate.getMonth() === selectedMonthPdf);
          const receitasMes = monthEntriesPdf.filter((e)=>e.entry_type === "RECEITA").reduce((s,e)=>s + e.amountNumber, 0);
          const despesasMes = monthEntriesPdf.filter((e)=>e.entry_type === "DESPESA").reduce((s,e)=>s + e.amountNumber, 0);
          const saldoMes = receitasMes - despesasMes;

          const hojePdf = new Date();
          const diaDoMesPdf = hojePdf.getDate();
          const diasNoMesPdf = new Date(hojePdf.getFullYear(), hojePdf.getMonth()+1, 0).getDate();
          const taxaPoupancaPdf = receitasMes > 0 ? Math.round((saldoMes / receitasMes) * 100) : 0;
          const burnRatePdf = despesasMes / Math.max(diaDoMesPdf, 1);
          const saldoProjetadoPdf = receitasMes - (burnRatePdf * diasNoMesPdf);

          const topExpensesPdf = monthEntriesPdf
            .filter((e)=>e.entry_type === "DESPESA")
            .sort((a,b)=>b.amountNumber - a.amountNumber)
            .slice(0,10);
          const topCategoriesPdf = [...catsPdf].slice(0,8);

          const recurringFixedExpenseTotalPdf = fixedExpensesPdf
            .filter((i)=>i.is_recurring)
            .reduce((s,i)=>s + Number(i.amount || 0), 0);
          const recurringFixedIncomeTotalPdf = fixedIncomesPdf
            .filter((i)=>i.is_recurring)
            .reduce((s,i)=>s + Number(i.amount || 0), 0);
          const commitmentPctRawPdf = recurringFixedIncomeTotalPdf > 0
            ? (recurringFixedExpenseTotalPdf / recurringFixedIncomeTotalPdf) * 100
            : 0;

          const pdf = new window.jspdf.jsPDF("p", "mm", "a4");
          const pageWidth = pdf.internal.pageSize.getWidth();
          const margin = 10;
          const maxY = 285;
          let y = 12;

          const ensureSpace = (needed=6)=>{
            if(y + needed > maxY){
              pdf.addPage();
              y = 12;
            }
          };
          const line = (text, size=10, bold=false, color=[20,20,20])=>{
            pdf.setFont("helvetica", bold ? "bold" : "normal");
            pdf.setFontSize(size);
            pdf.setTextColor(color[0], color[1], color[2]);
            const wrapped = pdf.splitTextToSize(String(text), pageWidth - (margin * 2));
            wrapped.forEach((w)=>{
              ensureSpace(6);
              pdf.text(w, margin, y);
              y += 5;
            });
          };
          const section = (title)=>{
            ensureSpace(10);
            y += 2;
            line(title, 12, true, [30, 64, 175]);
            y += 1;
          };

          line("GenFin - Relatório Financeiro Detalhado", 14, true, [15, 23, 42]);
          line(`Período selecionado no dashboard: ${monthNames[selectedMonthPdf]}/${selectedYearPdf}`, 10);
          line(`Emitido em: ${new Date().toLocaleString("pt-BR")}`, 10);
          y += 2;

          section("Resumo Geral");
          line(`Receitas (mês): ${formatCurrency(receitasMes)}`);
          line(`Despesas (mês): ${formatCurrency(despesasMes)}`);
          line(`Saldo (mês): ${formatCurrency(saldoMes)}`);
          line(`Movimentações (mês): ${monthEntriesPdf.length}`);
          line(`Saldo geral da conta: ${formatCurrency(dashPdf.saldo)}`);

          section("Métricas do Dashboard");
          line(`Taxa de poupança: ${taxaPoupancaPdf}%`);
          line(`Burn rate (R$/dia): ${formatCurrency(burnRatePdf)}`);
          line(`Projeção fim do mês: ${formatCurrency(saldoProjetadoPdf)}`);
          line(`Comprometimento fixo: ${Math.round(commitmentPctRawPdf)}% (${formatCurrency(recurringFixedExpenseTotalPdf)} de ${formatCurrency(recurringFixedIncomeTotalPdf)})`);

          section("Resumo por Janela de Tempo");
          line(`Hoje - Entradas: ${formatCurrency(dailyPdf.total_receita)} | Saídas: ${formatCurrency(dailyPdf.total_despesa)} | Mov: ${dailyPdf.movimentacoes}`);
          line(`Últimos 7 dias - Entradas: ${formatCurrency(weeklyPdf.total_receita)} | Saídas: ${formatCurrency(weeklyPdf.total_despesa)} | Mov: ${weeklyPdf.movimentacoes}`);
          line(`Últimos 30 dias - Entradas: ${formatCurrency(monthlyPdf.total_receita)} | Saídas: ${formatCurrency(monthlyPdf.total_despesa)} | Mov: ${monthlyPdf.movimentacoes}`);

          section("Top Categorias de Despesa");
          if(topCategoriesPdf.length === 0){
            line("Sem dados de categoria.");
          } else {
            topCategoriesPdf.forEach((c, idx)=>line(`${idx+1}. ${c.category}: ${formatCurrency(c.total)}`));
          }

          section("Top 10 Gastos do Mês");
          if(topExpensesPdf.length === 0){
            line("Sem gastos no período selecionado.");
          } else {
            topExpensesPdf.forEach((e, idx)=>line(`${idx+1}. ${e.date} - ${e.category} - ${formatCurrency(e.amountNumber)}`));
          }

          section("Movimentações Detalhadas do Mês");
          if(monthEntriesPdf.length === 0){
            line("Sem movimentações no período selecionado.");
          } else {
            monthEntriesPdf
              .sort((a,b)=>b.parsedDate - a.parsedDate)
              .forEach((e)=>line(`${e.date} | ${e.entry_type} | ${e.category} | ${formatCurrency(e.amountNumber)}`, 9));
          }

          section("Despesas Fixas");
          if(fixedExpensesPdf.length === 0){
            line("Sem despesas fixas cadastradas.");
          } else {
            fixedExpensesPdf.forEach((i)=>line(`${i.date} | ${i.category} | ${formatCurrency(i.amount)} | ${i.is_recurring ? "Recorrente" : "Não recorrente"}`, 9));
          }

          section("Entradas Fixas");
          if(fixedIncomesPdf.length === 0){
            line("Sem entradas fixas cadastradas.");
          } else {
            fixedIncomesPdf.forEach((i)=>line(`${i.date} | ${i.category} | ${formatCurrency(i.amount)} | ${i.is_recurring ? "Recorrente" : "Não recorrente"}`, 9));
          }

          section("Reservas");
          if(reservesPdf.length === 0){
            line("Sem reservas cadastradas.");
          } else {
            reservesPdf.forEach((i)=>line(`${i.date} | ${i.category} | ${formatCurrency(i.amount)} | ${i.is_recurring ? "Recorrente" : "Não recorrente"}`, 9));
          }

          const monthLabel = monthNames[selectedMonthPdf] || "mes";
          const fileName = `genfin-relatorio-detalhado-${monthLabel.toLowerCase()}-${new Date().toISOString().slice(0,10)}.pdf`;
          pdf.save(fileName);
        } catch (error){
          console.error(error);
          alert("Erro ao gerar PDF.");
        } finally{
          btn.textContent = originalText;
          btn.style.pointerEvents = "";
        }
      });
    }
    function initWhatsappSummary(){
      const btn = document.getElementById("sendWhatsBtn");
      if(!btn || btn.dataset.bound) return;
      btn.dataset.bound = "1";
      btn.addEventListener("click", async ()=>{
        const originalText = btn.textContent;
        btn.textContent = "⏳";
        btn.style.pointerEvents = "none";
        try{
          const month = document.querySelector(".month-chip.active")?.textContent || "-";
          const receita = document.getElementById("receita")?.innerText || "R$ 0,00";
          const despesa = document.getElementById("despesa")?.innerText || "R$ 0,00";
          const saldo = document.getElementById("saldo")?.innerText || "R$ 0,00";
          const mov = document.getElementById("movimentacoes")?.innerText || "0";
          const poupanca = document.getElementById("taxa_poupanca")?.innerText || "0%";
          const burn = document.getElementById("burn_rate")?.innerText || "R$ 0,00";
          const projecao = document.getElementById("projecao_fim_mes")?.innerText || "R$ 0,00";
          const commitment = document.getElementById("fixedCommitmentHint")?.innerText || "R$ 0,00 de R$ 0,00";

          const topRows = Array.from(document.querySelectorAll("#top5 .bar-row span"))
            .slice(0,3)
            .map((el)=>el.textContent)
            .filter(Boolean);

          const summary = [
            "Resumo GenFin",
            `Mês: ${month}`,
            `Receitas: ${receita}`,
            `Despesas: ${despesa}`,
            `Saldo: ${saldo}`,
            `Movimentações: ${mov}`,
            `Taxa de Poupança: ${poupanca}`,
            `Burn Rate (dia): ${burn}`,
            `Projeção fim do mês: ${projecao}`,
            `Comprometimento fixo: ${commitment}`,
            topRows.length ? `Top gastos: ${topRows.join(" | ")}` : "Top gastos: sem dados",
          ].join("\n");

          const csrfToken = getCsrfToken();
          if(!csrfToken){
            alert("Token CSRF não encontrado. Recarregue a página e tente novamente.");
            return;
          }

          const response = await fetch("/api/whatsapp-summary/", {
            method: "POST",
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify({
              text: summary,
              mode: localStorage.getItem("genfin_webhook_mode") === "dev" ? "dev" : "prod",
            }),
          });

          if(!response.ok){
            let msg = "Não foi possível enviar o resumo para o WhatsApp.";
            try{
              const data = await response.json();
              msg = data.error || msg;
            } catch (_error){
              // keep default
            }
            alert(msg);
            return;
          }
          alert("Resumo enviado para o webhook do WhatsApp.");
        } catch (error){
          console.error(error);
          alert("Erro ao enviar resumo.");
        } finally{
          btn.textContent = originalText;
          btn.style.pointerEvents = "";
        }
      });
    }
    function initVisibilityToggle(){
      const btn = document.getElementById("visibilityToggleBtn");
      if(!btn || btn.dataset.bound) return;
      btn.dataset.bound = "1";

      const applyState = (hidden)=>{
        document.body.classList.toggle("values-hidden", hidden);
        btn.classList.toggle("active", hidden);
        btn.textContent = hidden ? "🙈" : "👁";
        btn.title = hidden ? "Mostrar valores" : "Ocultar valores";
        btn.setAttribute("aria-label", btn.title);
      };

      const saved = localStorage.getItem("genfin_values_hidden") === "1";
      applyState(saved);

      btn.addEventListener("click", ()=>{
        const hidden = !document.body.classList.contains("values-hidden");
        localStorage.setItem("genfin_values_hidden", hidden ? "1" : "0");
        applyState(hidden);
      });
    }
    function initThemeToggle(){
      const dayBtn = document.getElementById("themeDayBtn");
      const nightBtn = document.getElementById("themeNightBtn");
      if(!dayBtn || !nightBtn || dayBtn.dataset.bound) return;

      const applyTheme = (mode)=>{
        const isLight = mode === "light";
        document.body.classList.toggle("theme-light", isLight);
        dayBtn.classList.toggle("active", isLight);
        nightBtn.classList.toggle("active", !isLight);
        if(window.Chart && Chart.instances){
          Object.values(Chart.instances).forEach((chart)=>{
            try{ chart.update(); } catch (_error){ /* ignore */ }
          });
        }
      };

      const saved = localStorage.getItem("genfin_theme_mode");
      applyTheme(saved === "light" ? "light" : "dark");

      dayBtn.dataset.bound = "1";
      nightBtn.dataset.bound = "1";
      dayBtn.addEventListener("click", ()=>{
        localStorage.setItem("genfin_theme_mode", "light");
        applyTheme("light");
      });
      nightBtn.addEventListener("click", ()=>{
        localStorage.setItem("genfin_theme_mode", "dark");
        applyTheme("dark");
      });
    }
    function initWebhookModeSwitch(){
      const devBtn = document.getElementById("webhookDevBtn");
      const prodBtn = document.getElementById("webhookProdBtn");
      if(!devBtn || !prodBtn || devBtn.dataset.bound) return;

      const applyMode = (mode)=>{
        const isDev = mode === "dev";
        devBtn.classList.toggle("active", isDev);
        prodBtn.classList.toggle("active", !isDev);
        localStorage.setItem("genfin_webhook_mode", isDev ? "dev" : "prod");
      };

      const saved = localStorage.getItem("genfin_webhook_mode");
      applyMode(saved === "dev" ? "dev" : "prod");

      devBtn.dataset.bound = "1";
      prodBtn.dataset.bound = "1";
      devBtn.addEventListener("click", ()=>applyMode("dev"));
      prodBtn.addEventListener("click", ()=>applyMode("prod"));
    }
    initPdfExport();
    initWebhookModeSwitch();
    initWhatsappSummary();
    initVisibilityToggle();
    initThemeToggle();
    function initPanelToggles(){
      document.querySelectorAll(".panel").forEach((panel, index)=>{
        let header = panel.querySelector(":scope > .panel-head");
        if(!header){
          header = panel.querySelector(":scope > .section-head");
        }
        if(!header){
          const h3 = panel.querySelector(":scope > h3");
          if(h3){
            header = document.createElement("div");
            header.className = "panel-head";
            panel.insertBefore(header, h3);
            header.appendChild(h3);
          }
        }
        if(!header) return;

        let body = panel.querySelector(":scope > .panel-body");
        if(!body){
          body = document.createElement("div");
          body.className = "panel-body";
          const children = Array.from(panel.children).filter((child)=>child !== header);
          children.forEach((child)=>body.appendChild(child));
          panel.appendChild(body);
        }
        if(!body.id){
          body.id = `panel-body-auto-${index}`;
        }

        let btn = header.querySelector(".panel-toggle");
        if(!btn){
          btn = document.createElement("button");
          btn.type = "button";
          btn.className = "panel-toggle";
          btn.title = "Recolher/Expandir";
          btn.textContent = "▾";
          header.appendChild(btn);
        }
        btn.dataset.target = body.id;
        if(btn.dataset.bound) return;
        btn.dataset.bound = "1";
        btn.addEventListener("click", ()=>{
          const targetId = btn.dataset.target;
          const targetBody = targetId ? document.getElementById(targetId) : null;
          if(!targetBody) return;
          const collapsed = panel.classList.toggle("collapsed");
          targetBody.hidden = collapsed;
          btn.setAttribute("aria-expanded", String(!collapsed));
          btn.textContent = collapsed ? "▸" : "▾";
        });
      });
    }
    initPanelToggles();

    function setLaunchMessage(text, isError){
      const msg = document.getElementById("launchMessage");
      msg.textContent = text;
      msg.style.color = isError ? "#ef4444" : "#22c55e";
    }
    function openLaunchModal(type){
      const overlay = document.getElementById("launchOverlay");
      const form = document.getElementById("launchForm");
      const title = document.getElementById("launchTitle");
      const typeInput = document.getElementById("launchType");
      const todayIso = new Date().toISOString().slice(0,10);
      typeInput.value = type;
      title.textContent = type === "RECEITA" ? "Nova Receita" : "Nova Despesa";
      form.reset();
      document.getElementById("launchDate").value = todayIso;
      setLaunchMessage("", false);
      overlay.classList.add("open");
    }
    function closeLaunchModal(){
      document.getElementById("launchOverlay").classList.remove("open");
    }

    const launchIncomeBtn = document.getElementById("addIncomeBtn");
    const launchExpenseBtn = document.getElementById("addExpenseBtn");
    const launchOverlay = document.getElementById("launchOverlay");
    const launchClose = document.getElementById("launchClose");
    const launchCancel = document.getElementById("launchCancel");
    const launchForm = document.getElementById("launchForm");

    if(!launchIncomeBtn.dataset.bound){
      launchIncomeBtn.dataset.bound = "1";
      launchExpenseBtn.dataset.bound = "1";
      launchClose.dataset.bound = "1";
      launchCancel.dataset.bound = "1";
      launchForm.dataset.bound = "1";

      launchIncomeBtn.addEventListener("click", ()=>openLaunchModal("RECEITA"));
      launchExpenseBtn.addEventListener("click", ()=>openLaunchModal("DESPESA"));
      launchClose.addEventListener("click", closeLaunchModal);
      launchCancel.addEventListener("click", closeLaunchModal);
      launchOverlay.addEventListener("click", (event)=>{
        if(event.target === launchOverlay) closeLaunchModal();
      });

      launchForm.addEventListener("submit", async (event)=>{
        event.preventDefault();
        const type = document.getElementById("launchType").value;
        const category = document.getElementById("launchCategory").value.trim();
        const amount = document.getElementById("launchAmount").value;
        const dateIso = document.getElementById("launchDate").value;
        const phone = dash.phone_number;

        if(!phone){
          setLaunchMessage("Sessao invalida. Faca login novamente.", true);
          return;
        }
        if(!category || !amount || !dateIso){
          setLaunchMessage("Preencha categoria, valor e data.", true);
          return;
        }

        const payload = {
          phone_number: phone,
          categoria: category,
          data: toBrDate(dateIso),
        };
        if(type === "RECEITA") payload.receita = amount;
        else payload.despesa = amount;

        const csrfToken = getCsrfToken();
        if(!csrfToken){
          setLaunchMessage("Token de segurança ausente. Recarregue a página e tente novamente.", true);
          return;
        }

        const response = await fetch("/api/financial-entry/", {
          method:"POST",
          credentials:"same-origin",
          headers:{
            "Content-Type":"application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify(payload),
        });

        if(!response.ok){
          let msg = "Nao foi possivel salvar o lancamento.";
          try{
            const data = await response.json();
            msg = data.error || msg;
          } catch (_error){
            // keep default message
          }
          setLaunchMessage(msg, true);
          return;
        }

        setLaunchMessage("Lancamento salvo com sucesso.", false);
        setTimeout(()=>window.location.reload(), 450);
      });
    }
    const monthNames = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
    const entriesParsed = entries.map((item)=>({
      ...item,
      parsedDate: parseBrDate(item.date),
      amountNumber: Number(item.amount || 0),
    }));
    const selectedYear = new Date().getFullYear();
    let selectedMonth = new Date().getMonth();
    let selectedMonthEntries = [];
    let selectedMonthEnd = startOfDay(new Date());

    const chartRegistry = {};
    function setBarChart(id, values){
      if(chartRegistry[id]) chartRegistry[id].destroy();
      chartRegistry[id] = new Chart(document.getElementById(id),{
        type:"bar",
        data:{ labels:["Entradas","Saídas"], datasets:[{ data:values, backgroundColor:["#22c55e","#ef4444"] }] },
        options:{ plugins:{ legend:{display:false} } }
      });
    }
    function setHeatmap(values){
      if(chartRegistry.heatmapWeek) chartRegistry.heatmapWeek.destroy();
      chartRegistry.heatmapWeek = new Chart(document.getElementById("heatmapWeek"),{
        type:"bar",
        data:{
          labels:["Dom","Seg","Ter","Qua","Qui","Sex","Sab"],
          datasets:[{ data:values, backgroundColor:"#ef4444" }]
        },
        options:{ plugins:{ legend:{display:false} } }
      });
    }
    function sumByType(list, type){
      return list.filter((e)=>e.entry_type === type).reduce((s,e)=>s + e.amountNumber, 0);
    }
    function stdDev(values){
      if(!values.length) return 0;
      const mean = values.reduce((a,b)=>a+b,0) / values.length;
      const variance = values.reduce((acc,v)=>acc + Math.pow(v - mean, 2), 0) / values.length;
      return Math.sqrt(variance);
    }
    function monthKey(year, month){
      return `${year}-${String(month+1).padStart(2,"0")}`;
    }
    function buildMonthlySeries(entriesList, monthsBack){
      const now = new Date();
      const out = [];
      for(let i=monthsBack-1;i>=0;i--){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const y = d.getFullYear();
        const m = d.getMonth();
        const start = new Date(y,m,1);
        const end = new Date(y,m+1,0);
        const monthEntries = entriesList.filter((e)=>inRange(e.parsedDate, start, end));
        out.push({
          key: monthKey(y,m),
          label: monthNames[m],
          year: y,
          month: m,
          receita: sumByType(monthEntries, "RECEITA"),
          despesa: sumByType(monthEntries, "DESPESA"),
        });
      }
      return out;
    }
    function statObj(list){
      const total_receita = sumByType(list, "RECEITA");
      const total_despesa = sumByType(list, "DESPESA");
      const movimentacoes = list.length;
      const total = total_receita + total_despesa || 1;
      return {
        total_receita,
        total_despesa,
        movimentacoes,
        percent_receita: Math.round((total_receita/total)*100),
        percent_despesa: Math.round((total_despesa/total)*100),
      };
    }
    function writeStats(prefix, stats, chartId){
      document.getElementById(prefix+"_in").innerText = formatCurrency(stats.total_receita);
      document.getElementById(prefix+"_out").innerText = formatCurrency(stats.total_despesa);
      document.getElementById(prefix+"_mov").innerText = stats.movimentacoes;
      document.getElementById(prefix+"_in_p").innerText = stats.percent_receita + "%";
      document.getElementById(prefix+"_out_p").innerText = stats.percent_despesa + "%";
      setBarChart(chartId, [stats.total_receita, stats.total_despesa]);
    }
    const centerTextPlugin = {
      id: "centerText",
      beforeDraw(chart) {
        const { ctx, chartArea } = chart;
        if (!chartArea) return;
        const pct = chart.config.data.datasets[0].data[0];
        const pctLabel = chart.config.data._pctLabel || (pct + "%");
        const val = chart.config.data._valor || 0;
        const x = (chartArea.left + chartArea.right) / 2;
        const y = (chartArea.top + chartArea.bottom) / 2;
        const styles = getComputedStyle(document.body);
        const mainTextColor = (styles.getPropertyValue("--text") || "#e5e7eb").trim();
        const subTextColor = (styles.getPropertyValue("--muted") || "#9ca3af").trim();
        ctx.save();
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = "700 14px Inter";
        ctx.fillStyle = mainTextColor;
        ctx.strokeStyle = document.body.classList.contains("theme-light") ? "rgba(255,255,255,.9)" : "rgba(2,6,23,.85)";
        ctx.lineWidth = 2;
        ctx.strokeText(pctLabel, x, y - 6);
        ctx.fillText(pctLabel, x, y - 6);
        ctx.font = "400 11px Inter";
        ctx.fillStyle = subTextColor;
        ctx.fillText("R$ " + Number(val).toLocaleString("pt-BR"), x, y + 10);
        ctx.restore();
      }
    };
    function renderCategoryGauges(expenseEntries){
      const expenseByCategory = {};
      expenseEntries.forEach((e)=>{
        const key = e.category || "Sem categoria";
        expenseByCategory[key] = (expenseByCategory[key] || 0) + e.amountNumber;
      });
      const rows = Object.entries(expenseByCategory)
        .map(([category,total])=>({category,total}))
        .sort((a,b)=>b.total-a.total)
        .slice(0,4);
      const total = rows.reduce((s,r)=>s + r.total, 0);
      for(let i=0;i<4;i++){
        const row = rows[i];
        const pct = row && total > 0 ? Math.round((row.total/total)*100) : 0;
        const value = row ? row.total : 0;
        const label = row ? row.category : "—";
        const chartId = "g"+(i+1);
        if(chartRegistry[chartId]) chartRegistry[chartId].destroy();
        chartRegistry[chartId] = new Chart(document.getElementById(chartId),{
          type:"doughnut",
          plugins:[centerTextPlugin],
          data:{
            labels:["Despesa","Restante"],
            datasets:[{data:[pct,100-pct],backgroundColor:["#ef4444","#1e293b"],borderWidth:0}],
            _valor: value
          },
          options:{cutout:"70%",plugins:{legend:{display:false}, tooltip:{enabled:false}}}
        });
        document.querySelectorAll(".gauge small")[i].innerText = label;
      }
    }

    let fixedExpenses = [];
    let fixedIncomes = [];
    let reserves = [];
    let vehicleSummaryData = {monthly_total:0, by_category:[], vehicle_count:0};
    try{
      fixedExpenses = await fetchJson("/api/planner/");
    } catch (plannerError){
      console.error("Falha ao carregar despesas fixas:", plannerError);
    }
    try{
      fixedIncomes = await fetchJson("/api/fixed-incomes/");
    } catch (incomeError){
      console.error("Falha ao carregar entradas fixas:", incomeError);
    }
    try{
      reserves = await fetchJson("/api/reserves/");
    } catch (reserveError){
      console.error("Falha ao carregar reservas:", reserveError);
    }
    async function loadVehicleSummary(month, year){
      try{
        vehicleSummaryData = await fetchJson(`/api/vehicles/summary/?month=${month}&year=${year}`);
      } catch (vehicleError){
        console.error("Falha ao carregar resumo de veículos:", vehicleError);
        vehicleSummaryData = {monthly_total:0, by_category:[], vehicle_count:0};
      }
    }

    const fixedByCategory = {};
    fixedExpenses.filter((item)=>item.is_recurring).forEach((item)=>{
      const category = item.category || "Sem categoria";
      fixedByCategory[category] = (fixedByCategory[category] || 0) + Number(item.amount || 0);
    });

    const fixedTop = Object.entries(fixedByCategory)
      .map(([category, total])=>({category, total}))
      .sort((a,b)=>b.total - a.total)
      .slice(0,4);

    const totalFixed = fixedTop.reduce((sum, item)=>sum + item.total, 0);
    fixedTop.forEach((item, i)=>{
      const pct = totalFixed > 0 ? Math.round((item.total / totalFixed) * 100) : 0;
      const chartData = {
        labels:["Despesa Fixa","Restante"],
        datasets:[{
          data:[pct, 100-pct],
          backgroundColor:["#38bdf8","#1e293b"],
          borderWidth:0
        }],
        _valor: item.total
      };

      new Chart(document.getElementById("fg"+(i+1)),{
        type:"doughnut",
        plugins:[centerTextPlugin],
        data: chartData,
        options:{
          cutout:"70%",
          plugins:{legend:{display:false}, tooltip:{enabled:false}}
        }
      });
      document.querySelectorAll(".fixed-gauge small")[i].innerText = item.category;
    });

    const recurringFixedExpenseTotal = fixedExpenses
      .filter((item)=>item.is_recurring)
      .reduce((sum, item)=>sum + Number(item.amount || 0), 0);
    const recurringFixedIncomeTotal = fixedIncomes
      .filter((item)=>item.is_recurring)
      .reduce((sum, item)=>sum + Number(item.amount || 0), 0);

    const fixedExpensesParsed = fixedExpenses.map((item)=>({
      ...item,
      parsedDate: parseIsoDate(item.date),
      amountNumber: Number(item.amount || 0),
    }));
    const fixedIncomesParsed = fixedIncomes.map((item)=>({
      ...item,
      parsedDate: parseIsoDate(item.date),
      amountNumber: Number(item.amount || 0),
    }));
    const reservesParsed = reserves.map((item)=>({
      ...item,
      parsedDate: parseIsoDate(item.date),
      amountNumber: Number(item.amount || 0),
    }));
    const monthsToCheck = 6;

    function getPeriodRange(period, anchorDate){
      const today = startOfDay(anchorDate || new Date());
      if(period === "week"){
        return {start: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 6), days:7};
      }
      if(period === "year"){
        return {start: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 364), days:365};
      }
      return {start: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 29), days:30};
    }
    function getPreviousRange(range){
      const endPrev = new Date(range.start.getFullYear(), range.start.getMonth(), range.start.getDate() - 1);
      const startPrev = new Date(endPrev.getFullYear(), endPrev.getMonth(), endPrev.getDate() - (range.days - 1));
      return {start: startPrev, end: endPrev};
    }
    function inRange(date, start, end){
      if(!date) return false;
      const d = startOfDay(date);
      return d >= startOfDay(start) && d <= startOfDay(end);
    }
    function getMonthBounds(year, month){
      return {
        start: new Date(year, month, 1),
        end: new Date(year, month + 1, 0),
      };
    }
    function sumByType(list, type){
      return list.filter((e)=>e.entry_type === type).reduce((s,e)=>s + e.amountNumber, 0);
    }
    function buildCategoryDistribution(expenseEntries){
      const map = {};
      expenseEntries.forEach((e)=>{
        const key = e.category || "Sem categoria";
        map[key] = (map[key] || 0) + e.amountNumber;
      });
      return Object.entries(map).sort((a,b)=>b[1]-a[1]);
    }
    function recurringLargest(){
      const items = fixedExpensesParsed.filter((e)=>e.is_recurring);
      if(items.length === 0) return null;
      return items.reduce((max, item)=>item.amountNumber > max.amountNumber ? item : max, items[0]);
    }
    function streakMonthsSaving(){
      const today = new Date();
      let streak = 0;
      for(let i=0;i<monthsToCheck;i++){
        const monthDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const start = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
        const end = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
        const monthEntries = entriesParsed.filter((e)=>inRange(e.parsedDate, start, end));
        const receita = sumByType(monthEntries, "RECEITA");
        const despesa = sumByType(monthEntries, "DESPESA");
        if(receita > despesa) streak += 1;
        else break;
      }
      return streak;
    }
    function renderTop5(expenseEntries){
      const top5 = [...expenseEntries].sort((a,b)=>b.amountNumber-a.amountNumber).slice(0,5);
      const max = Math.max(...top5.map((e)=>e.amountNumber),1);
      const topBox = document.getElementById("top5");
      topBox.textContent = "";
      top5.forEach((e)=>{
        const row = document.createElement("div");
        row.className = "bar-row";
        const label = document.createElement("span");
        label.textContent = `${e.category} (${formatCurrency(e.amountNumber)})`;
        const barBg = document.createElement("div");
        barBg.className = "bar-bg";
        const barFill = document.createElement("div");
        barFill.className = "bar-fill";
        barFill.style.width = `${(e.amountNumber/max)*100}%`;
        barBg.appendChild(barFill);
        row.appendChild(label);
        row.appendChild(barBg);
        topBox.appendChild(row);
      });
      if(top5.length === 0){
        topBox.textContent = "Sem dados no periodo selecionado.";
      }
    }
    const miniDonutCharts = {};
    const effCharts = {};
    function renderMiniDonut(canvasId, pctRaw, value, color, pctLabel, hintId, hintText){
      const pct = clampPercent(pctRaw);
      if(miniDonutCharts[canvasId]){
        miniDonutCharts[canvasId].destroy();
      }
      miniDonutCharts[canvasId] = new Chart(document.getElementById(canvasId),{
        type:"doughnut",
        plugins:[centerTextPlugin],
        data:{
          labels:["Valor","Restante"],
          datasets:[{
            data:[pct, 100 - pct],
            backgroundColor:[color,"#1e293b"],
            borderWidth:0
          }],
          _valor: value,
          _pctLabel: pctLabel || `${pct}%`
        },
        options:{
          cutout:"70%",
          plugins:{legend:{display:false}, tooltip:{enabled:false}}
        }
      });
      if(hintId){
        document.getElementById(hintId).innerText = hintText;
      }
    }
    let upcomingBase = [];
    function applyPeriodFilter(period){
      document.querySelectorAll(".period-btn").forEach((btn)=>{
        btn.classList.toggle("active", btn.dataset.period === period);
      });

      const today = selectedMonthEnd;
      const range = getPeriodRange(period, today);
      const periodEntries = selectedMonthEntries.filter((e)=>inRange(e.parsedDate, range.start, today));
      const previous = getPreviousRange(range);
      const prevEntries = selectedMonthEntries.filter((e)=>inRange(e.parsedDate, previous.start, previous.end));

      const receitaPeriodo = sumByType(periodEntries, "RECEITA");
      const despesaPeriodo = sumByType(periodEntries, "DESPESA");
      const receitaAnterior = sumByType(prevEntries, "RECEITA");
      const despesaAnterior = sumByType(prevEntries, "DESPESA");
      const selectedBounds = getMonthBounds(selectedYear, selectedMonth);
      const prevBounds = getMonthBounds(selectedYear, selectedMonth - 1);
      const selectedMonthAllEntries = entriesParsed.filter((e)=>inRange(e.parsedDate, selectedBounds.start, selectedBounds.end));
      const prevMonthAllEntries = entriesParsed.filter((e)=>inRange(e.parsedDate, prevBounds.start, prevBounds.end));
      const trendReceita = sumByType(selectedMonthAllEntries, "RECEITA") - sumByType(prevMonthAllEntries, "RECEITA");
      const trendDespesa = sumByType(selectedMonthAllEntries, "DESPESA") - sumByType(prevMonthAllEntries, "DESPESA");

      const expenseEntries = periodEntries.filter((e)=>e.entry_type === "DESPESA");
      const dailyBurn = despesaPeriodo / Math.max(range.days, 1);
      const runwayDays = dailyBurn > 0 ? Math.floor(Number(dash.saldo || 0) / dailyBurn) : 0;

      document.getElementById("runwayValue").innerText = runwayDays > 0 ? `${runwayDays} dias` : "0 dias";
      document.getElementById("runwaySub").innerText = `Burn medio: ${formatCurrency(dailyBurn)}/dia`;

      const receitaTrendEl = document.getElementById("trendReceita");
      receitaTrendEl.className = `trend ${trendClass(trendReceita)}`;
      receitaTrendEl.innerText = `${trendSymbol(trendReceita)} ${formatCurrency(Math.abs(trendReceita))} vs mês passado`;

      const despesaTrendEl = document.getElementById("trendDespesa");
      despesaTrendEl.className = `trend ${trendClass(-trendDespesa)}`;
      despesaTrendEl.innerText = `${trendSymbol(-trendDespesa)} ${formatCurrency(Math.abs(trendDespesa))} vs mês passado`;

      const saldoTrendEl = document.getElementById("trendSaldo");
      const saldoPeriodo = sumByType(selectedMonthAllEntries, "RECEITA") - sumByType(selectedMonthAllEntries, "DESPESA");
      const saldoAnterior = sumByType(prevMonthAllEntries, "RECEITA") - sumByType(prevMonthAllEntries, "DESPESA");
      const deltaSaldo = saldoPeriodo - saldoAnterior;
      saldoTrendEl.className = `trend ${trendClass(deltaSaldo)}`;
      saldoTrendEl.innerText = `${trendSymbol(deltaSaldo)} ${formatCurrency(Math.abs(deltaSaldo))} vs mês passado`;

      const streak = streakMonthsSaving();
      const distribution = buildCategoryDistribution(expenseEntries);
      const leisure = distribution.find((d)=>["lazer","entretenimento","restaurante","delivery"].includes(String(d[0]).toLowerCase()));
      const leisureValue = leisure ? leisure[1] : 0;
      const budgetBase = Math.max(receitaPeriodo, 1);
      const overLeisure = leisureValue > budgetBase * 0.2;

      const badgeBox = document.getElementById("badgesBox");
      badgeBox.textContent = "";
      if(streak >= 3){
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = `${streak} meses consecutivos economizando`;
        badgeBox.appendChild(badge);
      }
      if(overLeisure){
        const badge = document.createElement("span");
        badge.className = "badge warn";
        badge.textContent = "Orcamento estourado em lazer";
        badgeBox.appendChild(badge);
      }
      if(!badgeBox.childElementCount){
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = "Sem alertas criticos no periodo";
        badgeBox.appendChild(badge);
      }

      renderTop5(expenseEntries);

      const commitmentPctRaw = recurringFixedIncomeTotal > 0
        ? (recurringFixedExpenseTotal / recurringFixedIncomeTotal) * 100
        : 0;
      renderMiniDonut(
        "fixedCommitmentChart",
        commitmentPctRaw,
        recurringFixedExpenseTotal,
        "#ef4444",
        `${Math.round(commitmentPctRaw)}%`,
        "fixedCommitmentHint",
        `${formatCurrency(recurringFixedExpenseTotal)} de ${formatCurrency(recurringFixedIncomeTotal)}`
      );

      const coveragePctRaw = recurringFixedExpenseTotal > 0
        ? (recurringFixedIncomeTotal / recurringFixedExpenseTotal) * 100
        : 0;
      renderMiniDonut(
        "fixedCoverageChart",
        coveragePctRaw,
        recurringFixedIncomeTotal,
        "#22c55e",
        `${Math.round(coveragePctRaw)}%`,
        "fixedCoverageHint",
        `Entradas fixas cobrem ${formatCurrency(recurringFixedExpenseTotal)}`
      );

      const fixedWeightPctRaw = despesaPeriodo > 0
        ? (recurringFixedExpenseTotal / despesaPeriodo) * 100
        : 0;
      renderMiniDonut(
        "fixedWeightChart",
        fixedWeightPctRaw,
        recurringFixedExpenseTotal,
        "#38bdf8",
        `${Math.round(fixedWeightPctRaw)}%`,
        "fixedWeightHint",
        `Peso nas saidas do periodo: ${formatCurrency(despesaPeriodo)}`
      );

      const reserveMonths = recurringFixedExpenseTotal > 0
        ? Number(dash.saldo || 0) / recurringFixedExpenseTotal
        : 0;
      const reservePctRaw = recurringFixedExpenseTotal > 0 ? (reserveMonths / 6) * 100 : 0;
      renderMiniDonut(
        "fixedReserveChart",
        reservePctRaw,
        Number(dash.saldo || 0),
        "#eab308",
        `${reserveMonths.toFixed(1)}m`,
        "fixedReserveHint",
        "Meta sugerida: 6 meses de despesas fixas"
      );

      const fixedPeriodItems = fixedExpensesParsed.filter((item)=>{
        if(item.is_recurring) return true;
        return inRange(item.parsedDate, range.start, today);
      });
      const fixedPaidItems = fixedPeriodItems.filter((item)=>item.is_paid);
      const fixedUnpaidItems = fixedPeriodItems.filter((item)=>!item.is_paid);
      const fixedPaidCount = fixedPaidItems.length;
      const fixedTotalCount = fixedPeriodItems.length;
      const fixedPaidAmount = fixedPaidItems.reduce((sum, item)=>sum + item.amountNumber, 0);
      const fixedUnpaidAmount = fixedUnpaidItems.reduce((sum, item)=>sum + item.amountNumber, 0);
      const fixedPaidPctRaw = fixedTotalCount > 0 ? (fixedPaidCount / fixedTotalCount) * 100 : 0;
      renderMiniDonut(
        "fixedPaidChart",
        fixedPaidPctRaw,
        fixedPaidAmount,
        "#22c55e",
        `${fixedPaidCount}/${fixedTotalCount}`,
        "fixedPaidHint",
        `${formatCurrency(fixedPaidAmount)} pago | ${formatCurrency(fixedUnpaidAmount)} faltante`
      );
      document.getElementById("fixedPaidCount").innerText = `${fixedPaidCount}/${fixedTotalCount} pagas`;

      const vehicleMonthlyCost = Number(vehicleSummaryData.monthly_total || 0);
      document.getElementById("vehicle_monthly_cost").innerText = formatCurrency(vehicleMonthlyCost);
      const vehicleCostPct = despesaPeriodo > 0 ? (vehicleMonthlyCost / despesaPeriodo) * 100 : 0;
      renderMiniDonut(
        "vehicleCostDonut",
        vehicleCostPct,
        vehicleMonthlyCost,
        "#38bdf8",
        `${Math.round(vehicleCostPct)}%`,
        "vehicleCostHint",
        `Veículos: ${formatCurrency(vehicleMonthlyCost)} no mês`
      );

      const largestRecurring = recurringLargest();
      const insightBox = document.getElementById("insightsBox");
      insightBox.textContent = "";
      const lines = [];
      if(largestRecurring){
        const save10 = largestRecurring.amountNumber * 0.1;
        lines.push(`Seu maior gasto recorrente é ${largestRecurring.category} (${formatCurrency(largestRecurring.amountNumber)}). Reduzir 10% gera economia de ${formatCurrency(save10)}/mes.`);
      }
      lines.push(`No periodo ${period}, voce gastou ${formatCurrency(despesaPeriodo)} e recebeu ${formatCurrency(receitaPeriodo)}.`);
      if(runwayDays > 0){
        lines.push(`No ritmo atual, seu dinheiro dura aproximadamente ${runwayDays} dias.`);
      }
      lines.forEach((text)=>{
        const p = document.createElement("p");
        p.textContent = text;
        insightBox.appendChild(p);
      });

      const monthlySeries = buildMonthlySeries(entriesParsed, 12);
      const monthlyExpenses = monthlySeries.map((m)=>m.despesa);
      const monthlyIncomes = monthlySeries.map((m)=>m.receita);
      const avgMonthlyExpense = monthlyExpenses.reduce((a,b)=>a+b,0) / Math.max(monthlyExpenses.length,1);

      const iEf = receitaPeriodo > 0
        ? ((receitaPeriodo - recurringFixedExpenseTotal) / receitaPeriodo)
        : 0;
      const burnRateMensal = despesaPeriodo;
      const runwayMeses = avgMonthlyExpense > 0 ? Number(dash.saldo || 0) / avgMonthlyExpense : 0;
      const volatility = stdDev(monthlyExpenses);
      const cv = avgMonthlyExpense > 0 ? (volatility / avgMonthlyExpense) : 0;
      const deltaIncome = sumByType(selectedMonthAllEntries, "RECEITA") - sumByType(prevMonthAllEntries, "RECEITA");
      const deltaExpense = sumByType(selectedMonthAllEntries, "DESPESA") - sumByType(prevMonthAllEntries, "DESPESA");
      const incomeBase = Math.max(Math.abs(sumByType(prevMonthAllEntries, "RECEITA")), 1);
      const expenseBase = Math.max(Math.abs(sumByType(prevMonthAllEntries, "DESPESA")), 1);
      const incomePct = deltaIncome / incomeBase;
      const expensePct = deltaExpense / expenseBase;
      const elasticity = Math.abs(incomePct) > 0.0001 ? (expensePct / incomePct) : 0;
      const variableExpense = Math.max(despesaPeriodo - recurringFixedExpenseTotal, 0);
      const previsibilidade = (recurringFixedExpenseTotal + variableExpense) > 0
        ? (recurringFixedExpenseTotal / (recurringFixedExpenseTotal + variableExpense))
        : 0;

      document.getElementById("iefValue").innerText = `${Math.round(iEf*100)}%`;
      document.getElementById("burnMensalValue").innerText = formatCurrency(burnRateMensal);
      document.getElementById("runwayMesesValue").innerText = `${runwayMeses.toFixed(1)} meses`;
      document.getElementById("volatilidadeValue").innerText = formatCurrency(volatility);
      document.getElementById("elasticidadeValue").innerText = elasticity.toFixed(2);
      document.getElementById("previsibilidadeValue").innerText = `${Math.round(previsibilidade*100)}%`;

      const healthRadar = {
        ief: clampPercent(iEf * 100),
        burnControl: clampPercent(100 - ((despesaPeriodo / Math.max(receitaPeriodo,1)) * 100)),
        runway: clampPercent((runwayMeses / 6) * 100),
        estabilidade: clampPercent(100 - (cv * 100)),
        previsibilidade: clampPercent(previsibilidade * 100),
      };
      if(effCharts.healthRadar) effCharts.healthRadar.destroy();
      effCharts.healthRadar = new Chart(document.getElementById("healthRadarChart"),{
        type:"radar",
        data:{
          labels:["IEF","Controle Burn","Runway","Estabilidade","Previsibilidade"],
          datasets:[{
            label:"Saúde",
            data:[healthRadar.ief, healthRadar.burnControl, healthRadar.runway, healthRadar.estabilidade, healthRadar.previsibilidade],
            borderColor:"#38bdf8",
            backgroundColor:"rgba(56,189,248,.18)",
            pointBackgroundColor:"#38bdf8"
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{r:{beginAtZero:true,max:100,grid:{color:"rgba(148,163,184,.2)"},angleLines:{color:"rgba(148,163,184,.2)"},pointLabels:{color:"#94a3b8"},ticks:{display:false}}}
        }
      });

      if(effCharts.volatilityLine) effCharts.volatilityLine.destroy();
      effCharts.volatilityLine = new Chart(document.getElementById("volatilityLineChart"),{
        type:"line",
        data:{
          labels: monthlySeries.map((m)=>`${m.label}/${String(m.year).slice(2)}`),
          datasets:[{
            data: monthlyExpenses,
            borderColor:"#eab308",
            backgroundColor:"rgba(234,179,8,.2)",
            tension:.3,
            fill:true
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{x:{ticks:{color:"#94a3b8"}},y:{ticks:{color:"#94a3b8"}}}
        }
      });

      const previsibilidadePct = clampPercent(previsibilidade * 100);
      if(effCharts.previsibilidadeGauge) effCharts.previsibilidadeGauge.destroy();
      effCharts.previsibilidadeGauge = new Chart(document.getElementById("previsibilidadeGaugeChart"),{
        type:"doughnut",
        plugins:[centerTextPlugin],
        data:{
          labels:["Recorrente","Variável"],
          datasets:[{
            data:[previsibilidadePct, 100 - previsibilidadePct],
            backgroundColor:["#22c55e","#1e293b"],
            borderWidth:0
          }],
          _valor: recurringFixedExpenseTotal,
          _pctLabel: `${previsibilidadePct}%`
        },
        options:{cutout:"72%",plugins:{legend:{display:false}, tooltip:{enabled:false}}}
      });

      const reserveAmount = reservesParsed.reduce((sum, item)=>sum + item.amountNumber, 0);
      const essentialMonthly = recurringFixedExpenseTotal;
      const selectedMonthIncome = sumByType(selectedMonthAllEntries, "RECEITA");
      const selectedMonthExpense = sumByType(selectedMonthAllEntries, "DESPESA");
      const selectedMonthVariable = Math.max(selectedMonthExpense - essentialMonthly, 0);
      const next30Expenses = essentialMonthly + Math.max((selectedMonthExpense / Math.max(selectedBounds.end.getDate(), 1)) * 30 - essentialMonthly, 0);

      const irf = essentialMonthly > 0 ? reserveAmount / essentialMonthly : 0;
      const idealReserve = essentialMonthly * 6;
      const emergencyCoverage = idealReserve > 0 ? (reserveAmount / idealReserve) * 100 : 0;
      const liquidityExposure = Number(dash.saldo || 0) > 0 ? (next30Expenses / Number(dash.saldo || 1)) * 100 : 100;
      const survivalCost = selectedMonthIncome > 0 ? (essentialMonthly / selectedMonthIncome) * 100 : 0;

      document.getElementById("irfValue").innerText = irf.toFixed(2);
      document.getElementById("emergencyCoverageValue").innerText = `${Math.round(emergencyCoverage)}%`;
      document.getElementById("liquidityExposureValue").innerText = `${Math.round(liquidityExposure)}%`;
      document.getElementById("survivalCostValue").innerText = `${Math.round(survivalCost)}%`;

      const resiliencePct = clampPercent((irf / 6) * 100);
      if(effCharts.resilienceGauge) effCharts.resilienceGauge.destroy();
      effCharts.resilienceGauge = new Chart(document.getElementById("resilienceGaugeChart"),{
        type:"doughnut",
        plugins:[centerTextPlugin],
        data:{
          labels:["Resiliência","Gap"],
          datasets:[{
            data:[resiliencePct, 100 - resiliencePct],
            backgroundColor:["#22c55e","#1e293b"],
            borderWidth:0
          }],
          _valor: reserveAmount,
          _pctLabel: `${Math.round(irf * 10) / 10}m`
        },
        options:{cutout:"72%",plugins:{legend:{display:false}, tooltip:{enabled:false}}}
      });

      const securityRadarData = {
        resiliencia: resiliencePct,
        cobertura: clampPercent(emergencyCoverage),
        liquidez: clampPercent(100 - liquidityExposure),
        sobrevivencia: clampPercent(100 - survivalCost),
        flex: clampPercent(100 - ((essentialMonthly / Math.max(selectedMonthExpense, 1)) * 100)),
      };
      if(effCharts.securityRadar) effCharts.securityRadar.destroy();
      effCharts.securityRadar = new Chart(document.getElementById("securityRadarChart"),{
        type:"radar",
        data:{
          labels:["Resiliência","Cobertura","Liquidez","Sobrevivência","Flexibilidade"],
          datasets:[{
            data:[
              securityRadarData.resiliencia,
              securityRadarData.cobertura,
              securityRadarData.liquidez,
              securityRadarData.sobrevivencia,
              securityRadarData.flex
            ],
            borderColor:"#38bdf8",
            backgroundColor:"rgba(56,189,248,.18)",
            pointBackgroundColor:"#38bdf8"
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{r:{beginAtZero:true,max:100,grid:{color:"rgba(148,163,184,.2)"},angleLines:{color:"rgba(148,163,184,.2)"},pointLabels:{color:"#94a3b8"},ticks:{display:false}}}
        }
      });

      const incomeByCategory = {};
      fixedIncomesParsed.filter((item)=>item.is_recurring).forEach((item)=>{
        const key = item.category || "Sem categoria";
        incomeByCategory[key] = (incomeByCategory[key] || 0) + item.amountNumber;
      });
      const incomeRows = Object.entries(incomeByCategory).sort((a,b)=>b[1]-a[1]).slice(0,5);
      if(effCharts.incomeDependencyBar) effCharts.incomeDependencyBar.destroy();
      effCharts.incomeDependencyBar = new Chart(document.getElementById("incomeDependencyBarChart"),{
        type:"bar",
        data:{
          labels: incomeRows.length ? incomeRows.map((r)=>r[0]) : ["Sem dados"],
          datasets:[{
            data: incomeRows.length ? incomeRows.map((r)=>r[1]) : [0],
            backgroundColor:"#38bdf8"
          }]
        },
        options:{
          indexAxis:"y",
          plugins:{legend:{display:false}},
          scales:{x:{ticks:{color:"#94a3b8"}},y:{ticks:{color:"#94a3b8"}}}
        }
      });

      const fixedShare = clampPercent((essentialMonthly / Math.max(selectedMonthExpense, 1)) * 100);
      if(effCharts.fixedVsVariableDonut) effCharts.fixedVsVariableDonut.destroy();
      effCharts.fixedVsVariableDonut = new Chart(document.getElementById("fixedVsVariableDonutChart"),{
        type:"doughnut",
        plugins:[centerTextPlugin],
        data:{
          labels:["Fixos","Variáveis"],
          datasets:[{
            data:[fixedShare, 100 - fixedShare],
            backgroundColor:["#ef4444","#38bdf8"],
            borderWidth:0
          }],
          _valor: selectedMonthExpense,
          _pctLabel: `${fixedShare}%`
        },
        options:{cutout:"72%",plugins:{legend:{display:false}, tooltip:{enabled:false}}}
      });

      const flexibility = clampPercent(100 - fixedShare);
      if(effCharts.flexibilityGauge) effCharts.flexibilityGauge.destroy();
      effCharts.flexibilityGauge = new Chart(document.getElementById("flexibilityGaugeChart"),{
        type:"doughnut",
        plugins:[centerTextPlugin],
        data:{
          labels:["Flexível","Comprometido"],
          datasets:[{
            data:[flexibility, 100 - flexibility],
            backgroundColor:["#22c55e","#1e293b"],
            borderWidth:0
          }],
          _valor: selectedMonthVariable,
          _pctLabel: `${flexibility}%`
        },
        options:{cutout:"72%",plugins:{legend:{display:false}, tooltip:{enabled:false}}}
      });

      const sobra = selectedMonthIncome - essentialMonthly;
      if(effCharts.waterfall) effCharts.waterfall.destroy();
      effCharts.waterfall = new Chart(document.getElementById("waterfallChart"),{
        type:"bar",
        data:{
          labels:["Receita","Essenciais","Sobra"],
          datasets:[{
            data:[selectedMonthIncome, -essentialMonthly, sobra],
            backgroundColor:["#22c55e","#ef4444","#38bdf8"]
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{x:{ticks:{color:"#94a3b8"}},y:{ticks:{color:"#94a3b8"}}}
        }
      });

      const avgIncome = monthlyIncomes.reduce((a,b)=>a+b,0) / Math.max(monthlyIncomes.length,1);
      const avgExpense = monthlyExpenses.reduce((a,b)=>a+b,0) / Math.max(monthlyExpenses.length,1);
      const overspendRisk = avgIncome > 0 ? (avgExpense / avgIncome) * 100 : 0;
      const commitments = essentialMonthly;
      const annualIncome = avgIncome * 12;
      const insolvencyRisk = annualIncome > 0 ? (commitments * 12 / annualIncome) * 100 : 0;
      const financialPressure = selectedMonthIncome > 0 ? (commitments / selectedMonthIncome) * 100 : 0;
      const negativeMonths = monthlySeries.filter((m)=>m.receita - m.despesa < 0).length;
      const negativeProb = monthlySeries.length ? (negativeMonths / monthlySeries.length) * 100 : 0;
      const monthlyStress = selectedMonthIncome > 0 ? ((selectedMonthExpense - selectedMonthIncome) / selectedMonthIncome) * 100 : 0;

      document.getElementById("overspendRiskValue").innerText = `${Math.round(overspendRisk)}%`;
      document.getElementById("insolvencyRiskValue").innerText = `${Math.round(insolvencyRisk)}%`;
      document.getElementById("financialPressureValue").innerText = `${Math.round(financialPressure)}%`;
      document.getElementById("negativeBalanceProbValue").innerText = `${Math.round(negativeProb)}%`;
      document.getElementById("monthlyStressValue").innerText = `${Math.round(monthlyStress)}%`;

      const riskGaugePct = clampPercent((overspendRisk * 0.4) + (financialPressure * 0.3) + (negativeProb * 0.3));
      if(effCharts.riskGauge) effCharts.riskGauge.destroy();
      effCharts.riskGauge = new Chart(document.getElementById("riskGaugeChart"),{
        type:"doughnut",
        plugins:[centerTextPlugin],
        data:{
          labels:["Risco","Faixa segura"],
          datasets:[{
            data:[riskGaugePct, 100 - riskGaugePct],
            backgroundColor:["#ef4444","#1e293b"],
            borderWidth:0
          }],
          _valor: selectedMonthExpense,
          _pctLabel: `${riskGaugePct}%`
        },
        options:{cutout:"72%",plugins:{legend:{display:false}, tooltip:{enabled:false}}}
      });

      const stressSeries = monthlySeries.map((m)=>{
        if(m.receita <= 0) return 0;
        return ((m.despesa - m.receita) / m.receita) * 100;
      });
      if(effCharts.stressLine) effCharts.stressLine.destroy();
      effCharts.stressLine = new Chart(document.getElementById("stressLineChart"),{
        type:"line",
        data:{
          labels: monthlySeries.map((m)=>`${m.label}/${String(m.year).slice(2)}`),
          datasets:[{
            data: stressSeries,
            borderColor:"#ef4444",
            backgroundColor:"rgba(239,68,68,.2)",
            tension:.3,
            fill:true
          }]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{x:{ticks:{color:"#94a3b8"}},y:{ticks:{color:"#94a3b8"}}}
        }
      });

      const trafficDot = document.getElementById("collapseTrafficDot");
      const trafficLabel = document.getElementById("collapseTrafficLabel");
      if(riskGaugePct >= 70){
        trafficDot.className = "traffic-dot red";
        trafficLabel.textContent = "Alto risco";
      } else if(riskGaugePct >= 40){
        trafficDot.className = "traffic-dot yellow";
        trafficLabel.textContent = "Médio risco";
      } else {
        trafficDot.className = "traffic-dot green";
        trafficLabel.textContent = "Baixo risco";
      }

      const smartNotifs = [];
      if(overLeisure){
        smartNotifs.push({tipo:"Insight", categoria:"Lazer", valor:leisureValue, data:"Agora", falta:0});
      }
      if(runwayDays > 0 && runwayDays <= 30){
        smartNotifs.push({tipo:"Alerta", categoria:"Runway curto", valor:runwayDays, data:"Agora", falta:0, customText:`Runway em ${runwayDays} dias no ritmo atual.`});
      }
      renderNotifications([
        ...upcomingBase,
        ...smartNotifs.map((n)=>({
          ...n,
          smart: true,
          text: n.customText || `${n.tipo}: ${n.categoria} (${formatCurrency(n.valor)})`,
        })),
      ]);
    }

    const upcoming = [];
    const pushUpcoming = (items, tipo)=>{
      items.forEach((item)=>{
        const base = parseIsoDate(item.date);
        const due = nextOccurrence(base, Boolean(item.is_recurring));
        if(!due) return;
        const falta = daysUntil(due);
        if(falta < 0 || falta > 3) return;
        const dd = String(due.getDate()).padStart(2, "0");
        const mm = String(due.getMonth() + 1).padStart(2, "0");
        const yyyy = due.getFullYear();
        upcoming.push({
          tipo,
          categoria: item.category || "Sem categoria",
          valor: Number(item.amount || 0),
          data: `${dd}/${mm}/${yyyy}`,
          falta
        });
      });
    };
    pushUpcoming(fixedExpenses, "Despesa");
    pushUpcoming(fixedIncomes, "Entrada");
    upcoming.sort((a,b)=>a.falta - b.falta);
    upcomingBase = upcoming;

    const notifBtn = document.getElementById("notifBtn");
    const notifPanel = document.getElementById("notifPanel");
    notifBtn.addEventListener("click", (event)=>{
      event.stopPropagation();
      notifPanel.classList.toggle("open");
    });
    document.addEventListener("click", (event)=>{
      if(!notifPanel.contains(event.target) && !notifBtn.contains(event.target)){
        notifPanel.classList.remove("open");
      }
    });

    document.querySelectorAll(".period-btn").forEach((btn)=>{
      btn.addEventListener("click", ()=>applyPeriodFilter(btn.dataset.period));
    });

    async function renderTopSectionByMonth(monthIndex){
      selectedMonth = monthIndex;
      document.querySelectorAll(".month-chip").forEach((chip)=>{
        chip.classList.toggle("active", Number(chip.dataset.month) === monthIndex);
      });
      document.getElementById("selectedMonthLabel").innerText = `Ano ${selectedYear}`;

      selectedMonthEntries = entriesParsed.filter((e)=>{
        if(!e.parsedDate) return false;
        return e.parsedDate.getFullYear() === selectedYear && e.parsedDate.getMonth() === monthIndex;
      });

      const receitaMes = sumByType(selectedMonthEntries, "RECEITA");
      const despesaMes = sumByType(selectedMonthEntries, "DESPESA");
      const saldoMes = receitaMes - despesaMes;
      document.getElementById("receita").innerText = formatCurrency(receitaMes);
      document.getElementById("despesa").innerText = formatCurrency(despesaMes);
      document.getElementById("saldo").innerText = formatCurrency(saldoMes);
      document.getElementById("movimentacoes").innerText = selectedMonthEntries.length;

      const now = new Date();
      const isCurrentMonth = monthIndex === now.getMonth() && selectedYear === now.getFullYear();
      const monthStart = new Date(selectedYear, monthIndex, 1);
      const monthEnd = new Date(selectedYear, monthIndex + 1, 0);
      selectedMonthEnd = isCurrentMonth ? startOfDay(now) : startOfDay(monthEnd);
      const dayBase = isCurrentMonth ? now.getDate() : monthEnd.getDate();
      const taxaPoupanca = receitaMes > 0 ? Math.round((saldoMes / receitaMes) * 100) : 0;
      const burnRate = despesaMes / Math.max(dayBase,1);
      const despesaProjetada = burnRate * monthEnd.getDate();
      const saldoProjetado = receitaMes - despesaProjetada;
      document.getElementById("taxa_poupanca").innerText = taxaPoupanca + "%";
      document.getElementById("burn_rate").innerText = formatCurrency(burnRate);
      document.getElementById("projecao_fim_mes").innerText = formatCurrency(saldoProjetado);

      const weekMap = {0:0,1:0,2:0,3:0,4:0,5:0,6:0};
      selectedMonthEntries.forEach((e)=>{
        if(e.entry_type === "DESPESA" && e.parsedDate){
          weekMap[e.parsedDate.getDay()] += e.amountNumber;
        }
      });
      setHeatmap(Object.values(weekMap));

      const monthStats = statObj(selectedMonthEntries);
      const last7Start = new Date(selectedMonthEnd.getFullYear(), selectedMonthEnd.getMonth(), selectedMonthEnd.getDate() - 6);
      const last7Entries = selectedMonthEntries.filter((e)=>inRange(e.parsedDate, last7Start, selectedMonthEnd));
      const last7Stats = statObj(last7Entries);
      const prevMonthStart = new Date(selectedYear, monthIndex - 1, 1);
      const prevMonthEnd = new Date(selectedYear, monthIndex, 0);
      const prevMonthEntries = entriesParsed.filter((e)=>inRange(e.parsedDate, prevMonthStart, prevMonthEnd));
      const prevMonthStats = statObj(prevMonthEntries);
      writeStats("d", monthStats, "chartDaily");
      writeStats("w", last7Stats, "chartWeekly");
      writeStats("m", prevMonthStats, "chartMonthly");

      renderCategoryGauges(selectedMonthEntries.filter((e)=>e.entry_type === "DESPESA"));
      await loadVehicleSummary(monthIndex + 1, selectedYear);
      applyPeriodFilter("month");
    }

    const monthBar = document.getElementById("monthFilterBar");
    monthBar.textContent = "";
    monthNames.forEach((name, idx)=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "month-chip";
      btn.dataset.month = String(idx);
      btn.textContent = name;
      btn.addEventListener("click", ()=>renderTopSectionByMonth(idx));
      monthBar.appendChild(btn);
    });
    renderTopSectionByMonth(selectedMonth);
  } catch (error){
    console.error(error);
    document.getElementById("top5").textContent = "Erro ao carregar dados do dashboard.";
  }
}
document.addEventListener("DOMContentLoaded", load);
</script>
</head>

<body>

<div class="app-shell">
  <aside class="sidebar">
    <h4>Navegação</h4>
    <a class="side-link" href="/fixed-expenses/">Despesas Fixas</a>
    <a class="side-link" href="/fixed-incomes/">Entradas Fixas</a>
    <a class="side-link" href="/reserves/">Reservas</a>
    <a class="side-link" href="/vehicles/">Veículos</a>
  </aside>

<div class="container">

  <div class="header">
    <div class="user">
      <div class="avatar">GF</div>
      <div>
        <strong>GenFin</strong><br>
        <small style="color:#94a3b8">Painel Financeiro</small>
      </div>
    </div>
      <div class="header-actions">
      <div class="header-links">
        <div class="theme-switch" aria-label="Alternar tema">
          <button id="themeDayBtn" class="theme-btn" type="button" title="Tema claro">☀ Dia</button>
          <button id="themeNightBtn" class="theme-btn active" type="button" title="Tema escuro">🌙 Noite</button>
        </div>
        <div id="webhookModeSwitch" class="theme-switch" aria-label="Modo webhook" style="display:none">
          <button id="webhookDevBtn" class="theme-btn" type="button" title="Enviar para ambiente de teste">Dev</button>
          <button id="webhookProdBtn" class="theme-btn active" type="button" title="Enviar para ambiente de produção">Prod</button>
        </div>
        <button id="sendWhatsBtn" class="icon-link whatsapp" type="button" title="Enviar resumo para WhatsApp" aria-label="Enviar resumo para WhatsApp">🟢</button>
        <button id="visibilityToggleBtn" class="visibility-btn" type="button" title="Ocultar valores" aria-label="Ocultar valores">👁</button>
        <button id="exportPdfBtn" class="icon-link pdf" type="button" title="Exportar relatório em PDF" aria-label="Exportar relatório em PDF">📄</button>
      </div>
      <div class="notif-wrap">
        <button id="notifBtn" class="notif-btn" type="button">🔔</button>
        <div id="notifBadge" class="notif-badge" style="display:none">0</div>
        <div id="notifPanel" class="notif-panel">
          <div id="notifList"></div>
        </div>
      </div>
      <a href="/logout/" class="icon-link logout" title="Sair" aria-label="Sair">⎋</a>
    </div>
  </div>

  <div class="grid">

    <div class="left">
      <div class="panel" style="padding:12px 14px">
        <div class="section-head">
          <h3 style="margin:0">Filtro por Mês</h3>
          <small id="selectedMonthLabel" style="color:#94a3b8"></small>
        </div>
        <div id="monthFilterBar" class="month-bar"></div>
      </div>

      <div class="cards cards-top">
        <div class="card">
          <div class="card-head">
            <span>Receitas</span>
            <button type="button" id="addIncomeBtn" class="card-icon-btn" title="Nova receita">+</button>
          </div>
          <strong class="green" id="receita">R$ 0</strong>
        </div>
        <div class="card">
          <div class="card-head">
            <span>Despesas</span>
            <button type="button" id="addExpenseBtn" class="card-icon-btn minus" title="Nova despesa">-</button>
          </div>
          <strong class="red" id="despesa">R$ 0</strong>
        </div>
        <div class="card"><span>Saldo Atual</span><strong class="yellow" id="saldo">R$ 0</strong></div>
      </div>

      <div class="panel">
        <div class="section-head">
          <h3>Inteligencia Financeira</h3>
          <div class="period-filters">
            <button class="period-btn" data-period="week" type="button">Semana</button>
            <button class="period-btn active" data-period="month" type="button">Mes</button>
            <button class="period-btn" data-period="year" type="button">Ano</button>
          </div>
        </div>
        <div class="intel-grid">
          <div class="intel-left">
            <div class="mini-cards">
              <a class="mini-card mini-card-link" href="/transactions/">
                <h5>Movimentações</h5>
                <strong class="blue" id="movimentacoes">0</strong>
              </a>
              <div class="mini-card">
                <h5>Taxa de Poupança</h5>
                <strong class="green" id="taxa_poupanca">0%</strong>
              </div>
              <div class="mini-card">
                <h5>Burn Rate (R$/dia)</h5>
                <strong class="red" id="burn_rate">R$ 0</strong>
              </div>
              <div class="mini-card">
                <h5>Projeção Fim do Mês</h5>
                <strong class="yellow" id="projecao_fim_mes">R$ 0</strong>
              </div>
              <div class="mini-card">
                <h5>Custo Mensal Veículo</h5>
                <strong class="blue" id="vehicle_monthly_cost">R$ 0</strong>
              </div>
              <div class="mini-card">
                <h5>Tendência Saldo</h5>
                <div class="trend flat" id="trendSaldo">→ R$ 0,00 vs mês passado</div>
              </div>
              <div class="mini-card">
                <h5>Runway Pessoal</h5>
                <strong id="runwayValue">0 dias</strong>
                <div class="trend flat" id="runwaySub">Burn medio: R$ 0,00/dia</div>
              </div>
              <div class="mini-card">
                <h5>Tendencia Entradas</h5>
                <strong id="trendInValue">Entradas</strong>
                <div class="trend flat" id="trendReceita">→ R$ 0,00 vs mês passado</div>
              </div>
              <div class="mini-card">
                <h5>Tendencia Saidas</h5>
                <strong id="trendOutValue">Saidas</strong>
                <div class="trend flat" id="trendDespesa">→ R$ 0,00 vs mês passado</div>
              </div>
            </div>
            <div style="display:none">
              <h3>Badges</h3>
              <div class="badges" id="badgesBox"></div>
            </div>
            <div style="display:none">
              <h3>Insights Automaticos</h3>
              <div class="insight-box" id="insightsBox"></div>
            </div>
          </div>
          <div class="intel-right">
            <div class="mini-card card-donut">
              <h5>Comprometimento Fixo</h5>
              <canvas id="fixedCommitmentChart"></canvas>
              <small id="fixedCommitmentHint">R$ 0,00 de R$ 0,00</small>
            </div>
            <div class="mini-card card-donut">
              <h5>Cobertura de Fixas</h5>
              <canvas id="fixedCoverageChart"></canvas>
              <small id="fixedCoverageHint">Entradas fixas cobrem R$ 0,00</small>
            </div>
            <div class="mini-card card-donut">
              <h5>Peso nas Saidas</h5>
              <canvas id="fixedWeightChart"></canvas>
              <small id="fixedWeightHint">Peso nas saidas do periodo: R$ 0,00</small>
            </div>
            <div class="mini-card card-donut">
              <h5>Reserva para Fixas</h5>
              <canvas id="fixedReserveChart"></canvas>
              <small id="fixedReserveHint">Meta sugerida: 6 meses de despesas fixas</small>
            </div>
            <div class="mini-card card-donut">
              <h5>Contas Fixas Pagas</h5>
              <canvas id="fixedPaidChart"></canvas>
              <strong id="fixedPaidCount">0/0 pagas</strong>
              <small id="fixedPaidHint">R$ 0,00 pago | R$ 0,00 faltante</small>
            </div>
            <div class="mini-card card-donut">
              <h5>Peso Veículos</h5>
              <canvas id="vehicleCostDonut"></canvas>
              <small id="vehicleCostHint">Veículos: R$ 0,00 no mês</small>
            </div>
          </div>
        </div>
      </div>

      <div class="panel" id="panel-eficiencia">
        <div class="panel-head">
          <h3>Eficiência Financeira</h3>
          <button type="button" class="panel-toggle" data-target="body-eficiencia" aria-expanded="true" title="Recolher/Expandir">▾</button>
        </div>
        <div class="panel-body" id="body-eficiencia">
          <div class="eff-grid">
          <div class="eff-metrics">
            <div class="eff-item">
              <h6>Índice de Eficiência (IEF)</h6>
              <strong id="iefValue">0%</strong>
            </div>
            <div class="eff-item">
              <h6>Burn Rate Mensal</h6>
              <strong id="burnMensalValue">R$ 0,00</strong>
            </div>
            <div class="eff-item">
              <h6>Runway Pessoal</h6>
              <strong id="runwayMesesValue">0,0 meses</strong>
            </div>
            <div class="eff-item">
              <h6>Volatilidade de Gastos</h6>
              <strong id="volatilidadeValue">R$ 0,00</strong>
            </div>
            <div class="eff-item">
              <h6>Elasticidade por Renda</h6>
              <strong id="elasticidadeValue">0,00</strong>
            </div>
            <div class="eff-item">
              <h6>Previsibilidade</h6>
              <strong id="previsibilidadeValue">0%</strong>
            </div>
          </div>
          <div class="eff-charts">
            <div class="eff-card">
              <h6>Radar de Saúde Financeira</h6>
              <canvas id="healthRadarChart"></canvas>
            </div>
            <div class="eff-card">
              <h6>Volatilidade Mensal de Gastos</h6>
              <canvas id="volatilityLineChart"></canvas>
            </div>
            <div class="eff-card">
              <h6>Gauge de Previsibilidade</h6>
              <canvas id="previsibilidadeGaugeChart"></canvas>
            </div>
          </div>
          </div>
        </div>
      </div>

      <div class="panel" id="panel-seguranca">
        <div class="panel-head">
          <h3>Segurança Financeira</h3>
          <button type="button" class="panel-toggle" data-target="body-seguranca" aria-expanded="true" title="Recolher/Expandir">▾</button>
        </div>
        <div class="panel-body" id="body-seguranca">
          <div class="risk-grid">
          <div class="risk-metrics">
            <div class="risk-item">
              <h6>Índice de Resiliência (IRF)</h6>
              <strong id="irfValue">0,00</strong>
            </div>
            <div class="risk-item">
              <h6>Cobertura de Emergência</h6>
              <strong id="emergencyCoverageValue">0%</strong>
            </div>
            <div class="risk-item">
              <h6>Exposição a Liquidez</h6>
              <strong id="liquidityExposureValue">0%</strong>
            </div>
            <div class="risk-item">
              <h6>Custo Mínimo de Sobrevivência</h6>
              <strong id="survivalCostValue">0%</strong>
            </div>
          </div>
          <div class="risk-charts">
            <div class="eff-card">
              <h6>Gauge de Resiliência</h6>
              <canvas id="resilienceGaugeChart"></canvas>
            </div>
            <div class="eff-card">
              <h6>Radar de Segurança Financeira</h6>
              <canvas id="securityRadarChart"></canvas>
            </div>
            <div class="eff-card">
              <h6>Dependência por Fonte de Renda</h6>
              <canvas id="incomeDependencyBarChart"></canvas>
            </div>
            <div class="eff-card">
              <h6>Fixos vs Variáveis</h6>
              <canvas id="fixedVsVariableDonutChart"></canvas>
            </div>
            <div class="eff-card">
              <h6>Gauge de Flexibilidade</h6>
              <canvas id="flexibilityGaugeChart"></canvas>
            </div>
            <div class="eff-card">
              <h6>Waterfall: Receita → Essenciais → Sobra</h6>
              <canvas id="waterfallChart"></canvas>
            </div>
          </div>
          </div>
        </div>
      </div>

      <div class="panel" id="panel-risco">
        <div class="panel-head">
          <h3>Risco Financeiro Pessoal</h3>
          <button type="button" class="panel-toggle" data-target="body-risco" aria-expanded="true" title="Recolher/Expandir">▾</button>
        </div>
        <div class="panel-body" id="body-risco">
          <div class="risk-grid">
          <div class="risk-metrics">
            <div class="risk-item">
              <h6>Risco de Estouro Financeiro</h6>
              <strong id="overspendRiskValue">0%</strong>
            </div>
            <div class="risk-item">
              <h6>Risco de Insolvência (heur.)</h6>
              <strong id="insolvencyRiskValue">0%</strong>
            </div>
            <div class="risk-item">
              <h6>Índice de Pressão Financeira</h6>
              <strong id="financialPressureValue">0%</strong>
            </div>
            <div class="risk-item">
              <h6>Prob. de Saldo Negativo</h6>
              <strong id="negativeBalanceProbValue">0%</strong>
            </div>
            <div class="risk-item">
              <h6>Stress Financeiro Mensal</h6>
              <strong id="monthlyStressValue">0%</strong>
            </div>
            <div class="risk-item">
              <h6>Semáforo de Colapso</h6>
              <div class="traffic">
                <div id="collapseTrafficDot" class="traffic-dot green"></div>
                <div id="collapseTrafficLabel" class="traffic-label">Baixo risco</div>
              </div>
            </div>
          </div>
          <div class="risk-charts">
            <div class="eff-card">
              <h6>Gauge de Risco Financeiro</h6>
              <canvas id="riskGaugeChart"></canvas>
            </div>
            <div class="eff-card">
              <h6>Linha de Stress Financeiro</h6>
              <canvas id="stressLineChart"></canvas>
            </div>
          </div>
          </div>
        </div>
      </div>

      <div class="panel" id="panel-resumo-mov">
        <div class="panel-head">
          <h3>Resumo de Movimentações</h3>
          <button type="button" class="panel-toggle" data-target="body-resumo-mov" aria-expanded="true" title="Recolher/Expandir">▾</button>
        </div>
        <div class="panel-body" id="body-resumo-mov">
          <div class="stats">
          <div class="stat-card">
            <h4>Hoje</h4>
            <div class="metric">Entrou: <b id="d_in">R$ 0</b></div>
            <div class="metric">Saiu: <b id="d_out">R$ 0</b></div>
            <div class="metric">Movimentações: <b id="d_mov">0</b></div>
            <div class="metric">Entrada %: <b id="d_in_p">0%</b></div>
            <div class="metric">Saída %: <b id="d_out_p">0%</b></div>
            <canvas id="chartDaily"></canvas>
          </div>

          <div class="stat-card">
            <h4>Últimos 7 dias</h4>
            <div class="metric">Entrou: <b id="w_in">R$ 0</b></div>
            <div class="metric">Saiu: <b id="w_out">R$ 0</b></div>
            <div class="metric">Movimentações: <b id="w_mov">0</b></div>
            <div class="metric">Entrada %: <b id="w_in_p">0%</b></div>
            <div class="metric">Saída %: <b id="w_out_p">0%</b></div>
            <canvas id="chartWeekly"></canvas>
          </div>

          <div class="stat-card">
            <h4>Últimos 30 dias</h4>
            <div class="metric">Entrou: <b id="m_in">R$ 0</b></div>
            <div class="metric">Saiu: <b id="m_out">R$ 0</b></div>
            <div class="metric">Movimentações: <b id="m_mov">0</b></div>
            <div class="metric">Entrada %: <b id="m_in_p">0%</b></div>
            <div class="metric">Saída %: <b id="m_out_p">0%</b></div>
            <canvas id="chartMonthly"></canvas>
          </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Desempenho por Categoria (% da Despesa)</h3>
        <div class="gauges">
          <div class="gauge"><canvas id="g1"></canvas><small>—</small></div>
          <div class="gauge"><canvas id="g2"></canvas><small>—</small></div>
          <div class="gauge"><canvas id="g3"></canvas><small>—</small></div>
          <div class="gauge"><canvas id="g4"></canvas><small>—</small></div>
        </div>
      </div>

      <div class="panel">
        <h3>Desempenho por Despesas Fixas (% do Planejado)</h3>
        <div class="gauges">
          <div class="gauge fixed-gauge"><canvas id="fg1"></canvas><small>—</small></div>
          <div class="gauge fixed-gauge"><canvas id="fg2"></canvas><small>—</small></div>
          <div class="gauge fixed-gauge"><canvas id="fg3"></canvas><small>—</small></div>
          <div class="gauge fixed-gauge"><canvas id="fg4"></canvas><small>—</small></div>
        </div>
      </div>

<div class="panel panel-compact">
  <h3>Gastos por Dia da Semana</h3>
  <canvas id="heatmapWeek"></canvas>
</div>

<div class="panel">
  <h3>Top 5 Maiores Gastos</h3>
  <div id="top5"></div>
</div>


    </div>

  </div>
</div>
</div>
<div id="launchOverlay" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="launchTitle">
    <div class="modal-head">
      <h4 id="launchTitle">Novo Lançamento</h4>
      <button id="launchClose" type="button" class="modal-close">×</button>
    </div>
    <form id="launchForm" class="modal-body">
      <input id="launchType" type="hidden" value="RECEITA">
      <div class="field">
        <label for="launchCategory">Categoria</label>
        <input id="launchCategory" type="text" maxlength="80" required>
      </div>
      <div class="field">
        <label for="launchAmount">Valor</label>
        <input id="launchAmount" type="number" min="0.01" step="0.01" required>
      </div>
      <div class="field">
        <label for="launchDate">Data</label>
        <input id="launchDate" type="date" required>
      </div>
      <div class="field">
        <label for="launchDescription">Observação (opcional)</label>
        <textarea id="launchDescription" placeholder="Ex.: Mercado mensal, freelance, etc."></textarea>
      </div>
      <div id="launchMessage" class="modal-message"></div>
      <div class="modal-actions">
        <button id="launchCancel" type="button" class="modal-btn secondary">Cancelar</button>
        <button type="submit" class="modal-btn primary">Salvar</button>
      </div>
    </form>
  </div>
</div>
</body>
</html>


