<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>GenFin | Painel Financeiro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

/* === DARK FINTECH THEME === */
:root{
  --bg:#05070d;
  --bg-grad: radial-gradient(circle at top, #0a1020, #02030a 65%);
  --panel:#0b1224;
  --panel2:#0f1630;
  --border:rgba(56,189,248,.15);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --red:#ef4444;
  --blue:#38bdf8;
  --purple:#7c3aed;
  --pink:#db2777;
  --yellow:#eab308;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background: var(--bg-grad);
  color:var(--text);
}

.container{
  padding:20px;
  display:grid;
  grid-template-rows:auto 1fr;
  gap:20px;
}

/* HEADER */
.header{
  background:linear-gradient(180deg, #0b1224, #070b18);
  border-radius:16px;
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border:1px solid var(--border);
}

.user{display:flex;align-items:center;gap:12px;}
.avatar{
  width:42px;height:42px;border-radius:12px;
  background:linear-gradient(135deg,#0b1224,#020617);
  display:flex;align-items:center;justify-content:center;
  font-weight:700;color:#38bdf8;
  border:1px solid rgba(56,189,248,.25);
}

/* GRID */
.grid{display:grid;grid-template-columns:3fr 2fr;gap:20px;}
.left,.right{display:grid;gap:20px;}

/* PAINEL PADR√ÉO */
.panel{
  background:linear-gradient(180deg,#070b18,#020617);
  border-radius:18px;
  padding:18px;
  border:1px solid var(--border);
}

.panel h3{
  margin:0 0 12px;
  font-size:13px;
  color:#94a3b8;
  letter-spacing:.08em;
  text-transform:uppercase;
}

/* CARDS PRINCIPAIS */
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.card{
  background:linear-gradient(180deg,#0b1224,#020617);
  border-radius:16px;
  padding:18px;
  border:1px solid var(--border);
}
.card span{color:var(--muted);font-size:12px;}
.card strong{font-size:22px;display:block;margin-top:6px;}
.green{color:var(--green)} .red{color:var(--red)} .yellow{color:var(--yellow)} .blue{color:var(--blue)}

/* RESUMO NEON DARK */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;}
.stat-card{
  background:linear-gradient(180deg,#060b1a,#020617);
  border-radius:18px;
  padding:18px;
  border:1px solid rgba(56,189,248,.12);
  box-shadow:0 0 18px rgba(56,189,248,.08);
  transition:.25s;
}
.stat-card:hover{
  transform:translateY(-3px);
  box-shadow:0 0 28px rgba(56,189,248,.18);
}
.stat-card h4{
  margin:0 0 12px;
  color:#38bdf8;
  letter-spacing:.08em;
  text-transform:uppercase;
  font-size:11px;
}
.metric{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px dashed rgba(255,255,255,.06);
  font-size:12px;
}
.metric b{font-size:13px;}
.stat-card canvas{margin-top:12px;max-height:120px}

/* GAUGES */
.gauges{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.gauge{
  background:linear-gradient(180deg,#0b1224,#020617);
  border-radius:14px;
  padding:12px;
  text-align:center;
  border:1px solid var(--border);
}
.gauge canvas{max-height:90px}

/* BARRAS */
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;font-size:12px;color:#9ca3af;}
.bar-bg{flex:1;height:8px;background:#020617;border-radius:10px;overflow:hidden;}
.bar-fill{height:100%;background:linear-gradient(90deg,#7c3aed,#db2777);}

/* DIREITA */
.side-box{
  background:linear-gradient(180deg,#0b1224,#020617);
  border-radius:16px;
  padding:16px;
  border:1px solid var(--border);
}

/* TABELA */
table{width:100%;border-collapse:collapse;}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);font-size:12px;}
th{color:#9ca3af;text-align:left;}

@media(max-width:1100px){
  .grid{grid-template-columns:1fr}
  .cards{grid-template-columns:1fr 1fr}
}
</style>

<script>
async function load(){
  const dash = await fetch("/api/dashboard/", {credentials:"same-origin"}).then(r=>r.json());
  const entries = await fetch("/api/entries/", {credentials:"same-origin"}).then(r=>r.json());
  const cats = await fetch("/api/dashboard/categories/", {credentials:"same-origin"}).then(r=>r.json());

  document.getElementById("receita").innerText = "R$ " + dash.total_receita;
  document.getElementById("despesa").innerText = "R$ " + dash.total_despesa;
  document.getElementById("saldo").innerText   = "R$ " + dash.saldo;
  document.getElementById("movimentacoes").innerText = entries.length;

  const entriesReceita = document.getElementById("entriesReceita");
  const entriesDespesa = document.getElementById("entriesDespesa");
  entriesReceita.innerHTML = "";
  entriesDespesa.innerHTML = "";

  entries.slice(0,12).forEach(e=>{
    const row = `<tr><td>${e.date}</td><td>${e.category}</td><td>R$ ${e.amount}</td></tr>`;
    if(e.entry_type === "RECEITA") entriesReceita.innerHTML += row;
    else entriesDespesa.innerHTML += row;
  });

  const daily   = await fetch("/api/stats/daily/",   {credentials:"same-origin"}).then(r=>r.json());
  const weekly  = await fetch("/api/stats/weekly/",  {credentials:"same-origin"}).then(r=>r.json());
  const monthly = await fetch("/api/stats/monthly/", {credentials:"same-origin"}).then(r=>r.json());

  function render(prefix, data, chartId){
    document.getElementById(prefix+"_in").innerText = "R$ " + data.total_receita;
    document.getElementById(prefix+"_out").innerText = "R$ " + data.total_despesa;
    document.getElementById(prefix+"_mov").innerText = data.movimentacoes;
    document.getElementById(prefix+"_in_p").innerText = data.percent_receita + "%";
    document.getElementById(prefix+"_out_p").innerText = data.percent_despesa + "%";

    new Chart(document.getElementById(chartId),{
      type:"bar",
      data:{ labels:["Entradas","Sa√≠das"], datasets:[{ data:[data.total_receita, data.total_despesa], backgroundColor:["#22c55e","#ef4444"] }] },
      options:{ plugins:{ legend:{display:false} } }
    });
  }

  render("d", daily, "chartDaily");
  render("w", weekly, "chartWeekly");
  render("m", monthly, "chartMonthly");

  // === PLUGIN TEXTO CENTRAL (% + R$) ===
  const centerTextPlugin = {
    id: 'centerText',
    beforeDraw(chart) {
      const { ctx, chartArea } = chart;
      if (!chartArea) return;
      const pct = chart.config.data.datasets[0].data[0];
      const val = chart.config.data._valor || 0;

      const x = (chartArea.left + chartArea.right) / 2;
      const y = (chartArea.top + chartArea.bottom) / 2;

      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      ctx.font = '600 14px Inter';
      ctx.fillStyle = '#e5e7eb';
      ctx.fillText(pct + '%', x, y - 6);

      ctx.font = '400 11px Inter';
      ctx.fillStyle = '#9ca3af';
      ctx.fillText('R$ ' + Number(val).toLocaleString('pt-BR'), x, y + 10);

      ctx.restore();
    }
  };

  // === CATEGORIAS (% DESPESA) ===
  const totalDespesa = cats.reduce((sum,c)=>sum + c.total, 0);

  cats.slice(0,4).forEach((c, i)=>{
    const pct = Math.round((c.total / totalDespesa) * 100);

    const chartData = {
      labels:["Despesa","Restante"],
      datasets:[{
        data:[pct, 100-pct],
        backgroundColor:["#ef4444","#1e293b"],
        borderWidth:0
      }],
      _valor: c.total
    };

    new Chart(document.getElementById("g"+(i+1)),{
      type:"doughnut",
      plugins:[centerTextPlugin],
      data: chartData,
      options:{
        cutout:"70%",
        plugins:{legend:{display:false}, tooltip:{enabled:false}}
      }
    });

    document.querySelectorAll(".gauge small")[i].innerText = c.category;
  });
}
load();
</script>
</head>

<body>

<div class="container">

  <div class="header">
    <div class="user">
      <div class="avatar">GF</div>
      <div>
        <strong>GenFin</strong><br>
        <small style="color:#94a3b8">Painel Financeiro</small>
      </div>
    </div>
    <div style="cursor:pointer;color:#94a3b8">üìÖ Planner</div>
  </div>

  <div class="grid">

    <div class="left">

      <div class="cards">
        <div class="card"><span>Receitas</span><strong class="green" id="receita">R$ 0</strong></div>
        <div class="card"><span>Despesas</span><strong class="red" id="despesa">R$ 0</strong></div>
        <div class="card"><span>Saldo Atual</span><strong class="yellow" id="saldo">R$ 0</strong></div>
        <div class="card"><span>Movimenta√ß√µes</span><strong class="blue" id="movimentacoes">‚Äî</strong></div>
      </div>

      <div class="panel">
        <h3>Resumo de Movimenta√ß√µes</h3>
        <div class="stats">
          <div class="stat-card">
            <h4>Hoje</h4>
            <div class="metric">Entrou: <b id="d_in">R$ 0</b></div>
            <div class="metric">Saiu: <b id="d_out">R$ 0</b></div>
            <div class="metric">Movimenta√ß√µes: <b id="d_mov">0</b></div>
            <div class="metric">Entrada %: <b id="d_in_p">0%</b></div>
            <div class="metric">Sa√≠da %: <b id="d_out_p">0%</b></div>
            <canvas id="chartDaily"></canvas>
          </div>

          <div class="stat-card">
            <h4>√öltimos 7 dias</h4>
            <div class="metric">Entrou: <b id="w_in">R$ 0</b></div>
            <div class="metric">Saiu: <b id="w_out">R$ 0</b></div>
            <div class="metric">Movimenta√ß√µes: <b id="w_mov">0</b></div>
            <div class="metric">Entrada %: <b id="w_in_p">0%</b></div>
            <div class="metric">Sa√≠da %: <b id="w_out_p">0%</b></div>
            <canvas id="chartWeekly"></canvas>
          </div>

          <div class="stat-card">
            <h4>√öltimos 30 dias</h4>
            <div class="metric">Entrou: <b id="m_in">R$ 0</b></div>
            <div class="metric">Saiu: <b id="m_out">R$ 0</b></div>
            <div class="metric">Movimenta√ß√µes: <b id="m_mov">0</b></div>
            <div class="metric">Entrada %: <b id="m_in_p">0%</b></div>
            <div class="metric">Sa√≠da %: <b id="m_out_p">0%</b></div>
            <canvas id="chartMonthly"></canvas>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Desempenho por Categoria (% da Despesa)</h3>
        <div class="gauges">
          <div class="gauge"><canvas id="g1"></canvas><small>‚Äî</small></div>
          <div class="gauge"><canvas id="g2"></canvas><small>‚Äî</small></div>
          <div class="gauge"><canvas id="g3"></canvas><small>‚Äî</small></div>
          <div class="gauge"><canvas id="g4"></canvas><small>‚Äî</small></div>
        </div>
      </div>

      <div class="panel">
        <h3>Receita x Despesa</h3>
        <div class="bar-row">Receita<div class="bar-bg"><div class="bar-fill" style="width:70%"></div></div></div>
        <div class="bar-row">Despesa<div class="bar-bg"><div class="bar-fill" style="width:45%"></div></div></div>
      </div>

    </div>

    <div class="right">

      <div class="side-box">
        <h4 style="color:#22c55e">Entradas Recentes</h4>
        <table>
          <thead><tr><th>Data</th><th>Categoria</th><th>Valor</th></tr></thead>
          <tbody id="entriesReceita"></tbody>
        </table>
      </div>

      <div class="side-box">
        <h4 style="color:#ef4444">Despesas Recentes</h4>
        <table>
          <thead><tr><th>Data</th><th>Categoria</th><th>Valor</th></tr></thead>
          <tbody id="entriesDespesa"></tbody>
        </table>
      </div>

    </div>

  </div>
</div>

</body>
</html>
