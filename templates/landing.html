{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>GenFin | Plataforma Financeira</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="{% static 'accounts/favicon.svg' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

:root{
  --bg:#05070d;
  --bg-grad: radial-gradient(circle at top, #0a1020, #02030a 65%);
  --panel:#0b1224;
  --border:rgba(56,189,248,.15);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --red:#ef4444;
  --blue:#38bdf8;
  --yellow:#eab308;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background:var(--bg-grad);
  color:var(--text);
}

.wrap{max-width:1200px;margin:0 auto;padding:14px}

.topbar{
  position:sticky;top:10px;z-index:10;
  display:flex;justify-content:space-between;align-items:center;gap:12px;
  background:linear-gradient(180deg, #0b1224, #070b18);
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px 14px;
}
.logo{font-weight:700;letter-spacing:.08em;color:#bae6fd}
.actions{display:flex;gap:10px}
.btn{
  text-decoration:none;
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px 12px;
  color:#cbd5e1;
  font-size:13px;
}
.btn.primary{background:#38bdf8;color:#04111d;font-weight:700}

.hero{
  margin-top:14px;
  background:linear-gradient(140deg,#0b1224,#020617 60%);
  border:1px solid var(--border);
  border-radius:18px;
  padding:24px;
}
.hero h1{margin:0 0 8px;font-size:32px;line-height:1.1}
.hero p{margin:0;color:var(--muted);max-width:760px}

.panel{
  margin-top:14px;
  background:linear-gradient(180deg,#070b18,#020617);
  border-radius:18px;
  padding:18px;
  border:1px solid var(--border);
}
.panel h3{
  margin:0 0 12px;
  font-size:13px;
  color:#94a3b8;
  letter-spacing:.08em;
  text-transform:uppercase;
}

.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.card{
  background:linear-gradient(180deg,#0b1224,#020617);
  border-radius:16px;
  padding:14px;
  border:1px solid var(--border);
}
.card span{color:var(--muted);font-size:12px}
.card strong{font-size:22px;display:block;margin-top:8px}
.green{color:var(--green)} .red{color:var(--red)} .yellow{color:var(--yellow)} .blue{color:var(--blue)}

.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.stat-card{
  background:linear-gradient(180deg,#060b1a,#020617);
  border-radius:18px;
  padding:16px;
  border:1px solid rgba(56,189,248,.14);
  box-shadow:0 0 18px rgba(56,189,248,.08);
}
.stat-card h4{margin:0 0 10px;color:#38bdf8;font-size:11px;text-transform:uppercase;letter-spacing:.08em}
.metric{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px dashed rgba(255,255,255,.06);
  font-size:12px;
}
.metric b{font-size:13px}
.stat-card canvas{margin-top:10px;max-height:120px}

.gauges{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.gauge{
  background:linear-gradient(180deg,#0b1224,#020617);
  border-radius:14px;
  padding:12px;
  text-align:center;
  border:1px solid var(--border);
}
.gauge canvas{max-height:90px}
.gauge small{display:block;margin-top:6px;color:#94a3b8}

.split{display:grid;grid-template-columns:1.3fr 1fr;gap:12px}
.week-box,.calendar-box{
  background:linear-gradient(180deg,#0b1224,#020617);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
}
.top5-inline h3{margin:10px 0 6px;font-size:12px;color:#94a3b8;text-transform:uppercase;letter-spacing:.08em}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-size:12px;color:#9ca3af}
.bar-bg{flex:1;height:8px;background:#020617;border-radius:10px;overflow:hidden}
.bar-fill{height:100%;background:linear-gradient(90deg,#7c3aed,#db2777)}

.flow{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.step{
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  background:linear-gradient(180deg,#0b1224,#020617);
}
.step strong{display:block;margin-bottom:5px}

@media (max-width:980px){
  .cards,.stats,.gauges{grid-template-columns:1fr 1fr}
  .split,.flow{grid-template-columns:1fr}
}
@media (max-width:640px){
  .cards,.stats,.gauges{grid-template-columns:1fr}
  .hero h1{font-size:28px}
}
</style>
</head>
<body>
<div class="wrap">
  <header class="topbar">
    <div class="logo">GF | GenFin</div>
    <div class="actions">
      <a class="btn" href="/login/">Entrar</a>
      <a class="btn primary" href="/login/">Criar conta</a>
    </div>
  </header>

  <section class="hero">
    <h1>Veja o que realmente existe no app</h1>
    <p>Painel com estatisticas financeiras, leitura por periodo, distribuicao por categoria, custos de veiculo, uso de cartao e ranking dos maiores gastos em um unico lugar.</p>
  </section>

  <section class="panel">
    <h3>Cards principais do dashboard</h3>
    <div class="cards">
      <div class="card"><span>Receitas</span><strong class="green" id="receita">R$ 0,00</strong></div>
      <div class="card"><span>Despesas</span><strong class="red" id="despesa">R$ 0,00</strong></div>
      <div class="card"><span>Saldo Atual</span><strong class="yellow" id="saldo">R$ 0,00</strong></div>
    </div>
  </section>

  <section class="panel">
    <h3>Resumo de movimentacoes</h3>
    <div class="stats">
      <div class="stat-card">
        <h4>Hoje</h4>
        <div class="metric">Entrou: <b id="d_in">R$ 0,00</b></div>
        <div class="metric">Saiu: <b id="d_out">R$ 0,00</b></div>
        <div class="metric">Movimentacoes: <b id="d_mov">0</b></div>
        <div class="metric">Entrada %: <b id="d_in_p">0%</b></div>
        <div class="metric">Saida %: <b id="d_out_p">0%</b></div>
        <canvas id="chartDaily"></canvas>
      </div>
      <div class="stat-card">
        <h4>Ultimos 7 dias</h4>
        <div class="metric">Entrou: <b id="w_in">R$ 0,00</b></div>
        <div class="metric">Saiu: <b id="w_out">R$ 0,00</b></div>
        <div class="metric">Movimentacoes: <b id="w_mov">0</b></div>
        <div class="metric">Entrada %: <b id="w_in_p">0%</b></div>
        <div class="metric">Saida %: <b id="w_out_p">0%</b></div>
        <canvas id="chartWeekly"></canvas>
      </div>
      <div class="stat-card">
        <h4>Ultimos 30 dias</h4>
        <div class="metric">Entrou: <b id="m_in">R$ 0,00</b></div>
        <div class="metric">Saiu: <b id="m_out">R$ 0,00</b></div>
        <div class="metric">Movimentacoes: <b id="m_mov">0</b></div>
        <div class="metric">Entrada %: <b id="m_in_p">0%</b></div>
        <div class="metric">Saida %: <b id="m_out_p">0%</b></div>
        <canvas id="chartMonthly"></canvas>
      </div>
    </div>
  </section>

  <section class="panel">
    <h3>Desempenho por categoria e indicadores</h3>
    <div class="gauges">
      <div class="gauge"><canvas id="g1"></canvas><small id="g1Label">Categoria 1</small></div>
      <div class="gauge"><canvas id="g2"></canvas><small id="g2Label">Categoria 2</small></div>
      <div class="gauge"><canvas id="g3"></canvas><small id="g3Label">Categoria 3</small></div>
      <div class="gauge"><canvas id="g4"></canvas><small id="g4Label">Categoria 4</small></div>
    </div>
  </section>

  <section class="panel">
    <h3>Cartoes e custo de veiculos</h3>
    <div class="gauges">
      <div class="gauge"><canvas id="cardUsageChart"></canvas><small id="cardUsageLabel">Uso de limite</small></div>
      <div class="gauge"><canvas id="vehicleWeightChart"></canvas><small id="vehicleWeightLabel">Peso veiculos no mes</small></div>
      <div class="gauge"><canvas id="incomeExpenseRatioChart"></canvas><small id="incomeExpenseLabel">Receita x despesa</small></div>
      <div class="gauge"><canvas id="savingsChart"></canvas><small id="savingsLabel">Taxa de poupanca</small></div>
    </div>
  </section>

  <section class="panel">
    <h3>Gastos por dia da semana e top 5 maiores gastos</h3>
    <div class="split">
      <div class="week-box">
        <canvas id="heatmapWeek"></canvas>
        <div class="top5-inline">
          <h3>Top 5 maiores gastos</h3>
          <div id="top5"></div>
        </div>
      </div>
      <div class="calendar-box">
        <div class="metric"><span>Custo mensal de veiculo</span><b id="vehicleMonthlyCost">R$ 0,00</b></div>
        <div class="metric"><span>Custo de deslocamento</span><b id="vehicleCommuteCost">R$ 0,00</b></div>
        <div class="metric"><span>Uso de limite no cartao</span><b id="cardUsageText">0%</b></div>
        <div class="metric"><span>Movimentacoes registradas</span><b id="entriesCount">0</b></div>
      </div>
    </div>
  </section>

  <section class="panel">
    <h3>Como funciona no app</h3>
    <div class="flow">
      <div class="step"><strong>1. Lancamentos</strong>Registre entradas e despesas no dia a dia.</div>
      <div class="step"><strong>2. Planejamento</strong>Acompanhe fixas, reservas e cobertura do mes.</div>
      <div class="step"><strong>3. Analise</strong>Leia os graficos e cards para identificar tendencias.</div>
      <div class="step"><strong>4. Decisao</strong>Ajuste custos, cartoes e metas com base nos indicadores.</div>
    </div>
  </section>
</div>

<script>
const chartStore = {};
const weekNames = ["Dom","Seg","Ter","Qua","Qui","Sex","Sab"];

const demo = {
  daily: { total_receita: 3500, total_despesa: 420, movimentacoes: 8, percent_receita: 89, percent_despesa: 11 },
  weekly: { total_receita: 7900, total_despesa: 1820, movimentacoes: 27, percent_receita: 81, percent_despesa: 19 },
  monthly: { total_receita: 15015.85, total_despesa: 486.45, movimentacoes: 36, percent_receita: 97, percent_despesa: 3 },
  dashboard: { total_receita: 15015.85, total_despesa: 486.45, saldo: 14529.4 },
  categories: [
    { category: "Moradia", total: 2100 },
    { category: "Cartao", total: 1450 },
    { category: "Alimentacao", total: 890 },
    { category: "Transporte", total: 520 },
    { category: "Lazer", total: 280 }
  ],
  vehicle: { monthly_total: 1890.4, commute_monthly_cost: 612.2, vehicle_count: 2 },
  card: { usage_percent: 67.3, total_spent: 4212.5, total_limit: 6260.0 },
  entries: [
    { id:1, date:"10/02/2026", category:"Mercado", entry_type:"DESPESA", amount:350.9 },
    { id:2, date:"10/02/2026", category:"Combustivel", entry_type:"DESPESA", amount:190.2 },
    { id:3, date:"09/02/2026", category:"Salario", entry_type:"RECEITA", amount:6900 },
    { id:4, date:"08/02/2026", category:"Internet", entry_type:"DESPESA", amount:129.9 },
    { id:5, date:"07/02/2026", category:"Restaurante", entry_type:"DESPESA", amount:140.0 },
    { id:6, date:"06/02/2026", category:"Freela", entry_type:"RECEITA", amount:1200.0 },
    { id:7, date:"05/02/2026", category:"Farmacia", entry_type:"DESPESA", amount:98.5 }
  ]
};

function formatCurrency(value){
  return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(value || 0));
}
function percent(a,b){
  const n = Number(b || 0);
  if(n <= 0) return 0;
  return Math.round((Number(a || 0) / n) * 100);
}
async function getJson(url, fallback){
  try{
    const res = await fetch(url, { credentials:"same-origin" });
    if(!res.ok) return fallback;
    return await res.json();
  }catch(_error){
    return fallback;
  }
}
function setText(id, value){
  const el = document.getElementById(id);
  if(el) el.textContent = value;
}
function drawChart(key, id, type, data, options){
  const canvas = document.getElementById(id);
  if(!canvas) return;
  if(chartStore[key]) chartStore[key].destroy();
  chartStore[key] = new Chart(canvas.getContext("2d"), { type, data, options });
}

function renderSummaryCard(prefix, payload){
  setText(prefix + "_in", formatCurrency(payload.total_receita));
  setText(prefix + "_out", formatCurrency(payload.total_despesa));
  setText(prefix + "_mov", String(payload.movimentacoes || 0));
  setText(prefix + "_in_p", `${Math.round(payload.percent_receita || 0)}%`);
  setText(prefix + "_out_p", `${Math.round(payload.percent_despesa || 0)}%`);
}

function renderTop5(entries){
  const top5Box = document.getElementById("top5");
  const expenses = (entries || [])
    .filter((e)=>String(e.entry_type || "").toUpperCase() === "DESPESA")
    .sort((a,b)=>Number(b.amount || 0) - Number(a.amount || 0))
    .slice(0,5);
  if(!expenses.length){
    top5Box.innerHTML = '<div class="bar-row"><span>Sem gastos registrados</span></div>';
    return;
  }
  const max = Math.max(...expenses.map((e)=>Number(e.amount || 0)), 1);
  top5Box.innerHTML = expenses.map((e)=>{
    const val = Number(e.amount || 0);
    const p = (val / max) * 100;
    return `<div class="bar-row"><span>${e.category}: ${formatCurrency(val)}</span><div class="bar-bg"><div class="bar-fill" style="width:${p}%"></div></div></div>`;
  }).join("");
}

function renderWeekChart(entries){
  const sum = [0,0,0,0,0,0,0];
  (entries || []).forEach((e)=>{
    if(String(e.entry_type || "").toUpperCase() !== "DESPESA") return;
    const parts = String(e.date || "").split("/");
    if(parts.length !== 3) return;
    const d = new Date(Number(parts[2]), Number(parts[1]) - 1, Number(parts[0]));
    if(Number.isNaN(d.getTime())) return;
    sum[d.getDay()] += Number(e.amount || 0);
  });
  drawChart("week","heatmapWeek","bar",{
    labels: weekNames,
    datasets:[{
      label:"Gastos",
      data: sum,
      backgroundColor:"#db2777",
      borderRadius:6
    }]
  },{
    plugins:{legend:{display:false}},
    scales:{
      x:{ticks:{color:"#94a3b8"},grid:{color:"rgba(148,163,184,.16)"}},
      y:{ticks:{color:"#94a3b8"},grid:{color:"rgba(148,163,184,.16)"}}
    }
  });
}

async function initLanding(){
  const [daily, weekly, monthly, dashboard, categories, vehicle, card, entries] = await Promise.all([
    getJson("/api/stats/daily/", demo.daily),
    getJson("/api/stats/weekly/", demo.weekly),
    getJson("/api/stats/monthly/", demo.monthly),
    getJson("/api/dashboard/", demo.dashboard),
    getJson("/api/dashboard/categories/", demo.categories),
    getJson("/api/vehicles/summary/", demo.vehicle),
    getJson("/api/credit-cards/summary/", demo.card),
    getJson("/api/entries/?limit=80", demo.entries)
  ]);

  setText("receita", formatCurrency(dashboard.total_receita || monthly.total_receita));
  setText("despesa", formatCurrency(dashboard.total_despesa || monthly.total_despesa));
  setText("saldo", formatCurrency(dashboard.saldo || ((monthly.total_receita || 0) - (monthly.total_despesa || 0))));

  renderSummaryCard("d", daily);
  renderSummaryCard("w", weekly);
  renderSummaryCard("m", monthly);

  drawChart("daily","chartDaily","doughnut",{
    labels:["Entrada","Saida"],
    datasets:[{ data:[daily.percent_receita || 0, daily.percent_despesa || 0], backgroundColor:["#22c55e","#ef4444"], borderWidth:0 }]
  },{plugins:{legend:{labels:{color:"#cbd5e1"}}}});
  drawChart("weekly","chartWeekly","doughnut",{
    labels:["Entrada","Saida"],
    datasets:[{ data:[weekly.percent_receita || 0, weekly.percent_despesa || 0], backgroundColor:["#22c55e","#ef4444"], borderWidth:0 }]
  },{plugins:{legend:{labels:{color:"#cbd5e1"}}}});
  drawChart("monthly","chartMonthly","doughnut",{
    labels:["Entrada","Saida"],
    datasets:[{ data:[monthly.percent_receita || 0, monthly.percent_despesa || 0], backgroundColor:["#22c55e","#ef4444"], borderWidth:0 }]
  },{plugins:{legend:{labels:{color:"#cbd5e1"}}}});

  const topCategories = (categories || []).slice(0,4);
  for(let i=0;i<4;i++){
    const item = topCategories[i] || { category:`Categoria ${i+1}`, total:0 };
    const totalExpense = Number(monthly.total_despesa || 0) || 1;
    const p = Math.max(0, Math.min(100, (Number(item.total || 0) / totalExpense) * 100));
    setText(`g${i+1}Label`, `${item.category} (${Math.round(p)}%)`);
    drawChart(`g${i+1}`,`g${i+1}`,"doughnut",{
      labels:["Peso","Restante"],
      datasets:[{ data:[p, 100 - p], backgroundColor:["#38bdf8","#1e293b"], borderWidth:0 }]
    },{plugins:{legend:{display:false}}});
  }

  const cardUsage = Math.max(0, Math.min(100, Number(card.usage_percent || 0)));
  drawChart("cardUsage","cardUsageChart","doughnut",{
    labels:["Usado","Livre"],
    datasets:[{ data:[cardUsage, 100 - cardUsage], backgroundColor:["#f97316","#1e293b"], borderWidth:0 }]
  },{plugins:{legend:{display:false}}});
  setText("cardUsageLabel", `${formatCurrency(card.total_spent || 0)} de ${formatCurrency(card.total_limit || 0)} (${cardUsage.toFixed(1)}%)`);
  setText("cardUsageText", `${cardUsage.toFixed(1)}%`);

  const vehicleWeight = percent(vehicle.monthly_total || 0, monthly.total_despesa || 1);
  drawChart("vehicleWeight","vehicleWeightChart","doughnut",{
    labels:["Veiculos","Outros"],
    datasets:[{ data:[vehicleWeight, 100 - vehicleWeight], backgroundColor:["#0ea5e9","#1e293b"], borderWidth:0 }]
  },{plugins:{legend:{display:false}}});
  setText("vehicleWeightLabel", `${vehicleWeight}% das despesas do periodo`);

  const incomeExpense = percent(monthly.total_despesa || 0, monthly.total_receita || 1);
  drawChart("incomeExpense","incomeExpenseRatioChart","doughnut",{
    labels:["Despesa/Receita","Folga"],
    datasets:[{ data:[incomeExpense, 100 - incomeExpense], backgroundColor:["#ef4444","#1e293b"], borderWidth:0 }]
  },{plugins:{legend:{display:false}}});
  setText("incomeExpenseLabel", `${incomeExpense}% da receita comprometida`);

  const savings = percent((monthly.total_receita || 0) - (monthly.total_despesa || 0), monthly.total_receita || 1);
  drawChart("savings","savingsChart","doughnut",{
    labels:["Poupado","Nao poupado"],
    datasets:[{ data:[savings, 100 - savings], backgroundColor:["#22c55e","#1e293b"], borderWidth:0 }]
  },{plugins:{legend:{display:false}}});
  setText("savingsLabel", `${savings}% de taxa de poupanca`);

  renderWeekChart(entries);
  renderTop5(entries);

  setText("vehicleMonthlyCost", formatCurrency(vehicle.monthly_total || 0));
  setText("vehicleCommuteCost", formatCurrency(vehicle.commute_monthly_cost || 0));
  setText("entriesCount", String((entries || []).length));
}

initLanding();
</script>
</body>
</html>
