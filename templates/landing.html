{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>GenFin | Landing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="{% static 'accounts/favicon.svg' %}">
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#e5e7eb;
      --line:#b8bec7;
      --text:#1e293b;
      --muted:#475569;
      --green:#22a74e;
      --red:#ef4444;
      --orange:#f97316;
      --blue:#0891b2;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter,Segoe UI,Arial,sans-serif;
    }
    .wrap{max-width:1160px;margin:0 auto;padding:14px}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;
      border:1px solid var(--line);border-radius:14px;padding:12px 14px;background:#dde2e8;
    }
    .logo{font-weight:800}
    .actions{display:flex;gap:10px}
    .btn{
      text-decoration:none;font-size:14px;font-weight:700;color:var(--text);
      border:1px solid var(--line);padding:8px 12px;border-radius:10px;background:#eceff3;
    }
    .btn.primary{background:#d8eef3;color:#0f172a}
    .panel{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:var(--card);
      padding:14px;
    }
    .panel h2,.panel h3{margin:0 0 10px}
    .panel h2{font-size:26px}
    .panel h3{font-size:33px}
    .sub{margin:0;color:var(--muted)}
    .hero{padding:20px}

    .kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{
      border:1px solid var(--line);border-radius:13px;padding:10px;background:#e1e3e7;
    }
    .kpi span{display:block;color:#64748b;font-size:28px}
    .kpi strong{display:block;font-size:40px;line-height:1.2}
    .green{color:#1f8f46}.orange{color:#c96b09}

    .triplet{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .period-card{
      border:1px solid var(--line);border-radius:14px;padding:10px;background:#e1e3e7;margin-top:10px;
    }
    .period-head{display:flex;justify-content:space-between;color:#475569;font-weight:700;margin-bottom:8px}
    .line{display:grid;grid-template-columns:74px 1fr 40px;align-items:center;gap:8px;margin:6px 0}
    .track{height:11px;background:#cbd2dc;border-radius:999px;overflow:hidden}
    .fill{height:100%;border-radius:999px}
    .fill.income{background:#21a74d}
    .fill.expense{background:linear-gradient(90deg,#f59e0b,#ef4444)}
    .mini-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px}
    .mini{
      border:1px solid var(--line);border-radius:11px;padding:8px;background:#dde1e6;
    }
    .mini span{display:block;color:#64748b;font-size:22px}
    .mini strong{font-size:31px}

    .section-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .pill{
      display:inline-block;padding:6px 10px;border-radius:999px;
      border:1px solid #b7c5d8;background:#dce5ef;color:#334155;font-size:12px;
      font-family:Consolas,monospace;
    }
    .donut-row{display:flex;gap:12px;align-items:center}
    .donut{
      --pct:0;
      width:112px;height:112px;border-radius:50%;
      background:conic-gradient(var(--orange) calc(var(--pct)*1%), #cdd4de 0);
      position:relative;flex-shrink:0;
    }
    .donut::after{
      content:"";position:absolute;inset:14px;background:#e5e7eb;border-radius:50%;
    }
    .donut b{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      z-index:1;font-size:20px;
    }
    .metric-stack span{display:block;color:#64748b}
    .metric-stack strong{font-size:39px}

    .bars .row{display:grid;grid-template-columns:95px 1fr auto;gap:8px;align-items:center;margin:6px 0}
    .bars .track{height:12px}
    .bars strong{font-size:28px}

    .thermo{
      height:14px;border-radius:999px;overflow:hidden;border:1px solid var(--line);
      background:linear-gradient(90deg,#22c55e 0 35%, #eab308 35% 70%, #ef4444 70% 100%);
      position:relative;margin:8px 0 12px;
    }
    .pin{
      width:8px;height:24px;border-radius:6px;background:#0f172a;
      position:absolute;top:-5px;left:0;transform:translateX(-50%);
    }

    .screen{
      border:1px solid var(--line);border-radius:14px;background:#dfe2e7;overflow:hidden;
    }
    .screen-head{
      display:flex;gap:7px;align-items:center;padding:8px 10px;border-bottom:1px solid var(--line);color:#64748b;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:#bcc6d3}
    .screen-body{padding:10px;display:grid;gap:8px}
    .item{
      border:1px solid var(--line);border-radius:11px;background:#e8ebef;padding:9px;
      display:flex;justify-content:space-between;align-items:center;font-size:14px;
    }
    .status{
      border-radius:999px;padding:4px 8px;font-weight:700;font-size:12px;background:#d8eef3;color:#0e7490;
    }
    .status.warn{background:#fde8c8;color:#b45309}

    .foot{text-align:center;color:#64748b;font-size:12px;margin-top:12px}

    @media (max-width:960px){
      .triplet,.section-grid{grid-template-columns:1fr}
      .kpi-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="logo">GF | GenFin</div>
      <div class="actions">
        <a class="btn" href="/login/">Entrar</a>
        <a class="btn primary" href="/login/">Criar conta</a>
      </div>
    </header>

    <section class="panel hero">
      <h3>Painel de exemplo do GenFin</h3>
      <div class="kpi-grid">
        <div class="kpi"><span>Receitas</span><strong id="heroReceita">R$ 0,00</strong></div>
        <div class="kpi"><span>Despesas</span><strong id="heroDespesa">R$ 0,00</strong></div>
        <div class="kpi"><span>Saldo atual</span><strong id="heroSaldo" class="green">R$ 0,00</strong></div>
        <div class="kpi"><span>Taxa de poupanca</span><strong id="heroPoupanca">0%</strong></div>
        <div class="kpi"><span>Burn rate diario</span><strong id="heroBurn" class="orange">R$ 0,00</strong></div>
        <div class="kpi"><span>Runway</span><strong id="heroRunway">0 dias</strong></div>
      </div>
    </section>

    <section class="panel">
      <div id="periodList"></div>
    </section>

    <section class="section-grid" style="margin-top:12px">
      <article class="panel">
        <h2>Uso de limite no cartao</h2>
        <span class="pill">GET /api/credit-cards/summary/</span>
        <div class="donut-row" style="margin-top:10px">
          <div id="cardDonut" class="donut"><b id="cardPct">0%</b></div>
          <div class="metric-stack">
            <span>Uso total</span>
            <strong id="cardUsed">R$ 0,00</strong>
            <span id="cardLimit">de R$ 0,00</span>
          </div>
        </div>
        <div class="mini-grid">
          <div class="mini"><span>Cartoes</span><strong id="cardCount">0</strong></div>
          <div class="mini"><span>Pontos</span><strong id="cardPoints">0</strong></div>
          <div class="mini"><span>Cotacao USD</span><strong id="cardUsd">-</strong></div>
        </div>
      </article>

      <article class="panel">
        <h2>Despesas por categoria</h2>
        <span class="pill">GET /api/dashboard/categories/</span>
        <div id="categoryBars" class="bars" style="margin-top:10px"></div>
      </article>

      <article class="panel">
        <h2>Resumo de veiculos</h2>
        <span class="pill">GET /api/vehicles/summary/</span>
        <div id="vehicleBars" class="bars" style="margin-top:10px"></div>
        <div class="mini-grid">
          <div class="mini"><span>Custo mensal</span><strong id="vehicleMonthly">R$ 0,00</strong></div>
          <div class="mini"><span>Deslocamento</span><strong id="vehicleCommute">R$ 0,00</strong></div>
          <div class="mini"><span>Veiculos</span><strong id="vehicleCount">0</strong></div>
        </div>
      </article>
    </section>

    <section class="section-grid" style="margin-top:12px">
      <article class="panel">
        <h2>Movimentacoes + comprovante</h2>
        <span class="pill">POST /api/financial-entry/ | GET /api/entries/</span>
        <div class="screen" style="margin-top:10px">
          <div class="screen-head"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Lancamentos</div>
          <div class="screen-body">
            <div class="item"><b>10/02/2026 · Alimentacao</b><span>R$ 58,90</span></div>
            <div class="item"><span>Tipo: DESPESA</span><span class="status">Comprovante anexado</span></div>
            <div class="item"><span>09/02/2026 · Salario</span><span>R$ 6.900,00</span></div>
          </div>
        </div>
      </article>

      <article class="panel">
        <h2>Planejamento de fixas</h2>
        <span class="pill">GET /api/planner/ | /api/fixed-incomes/ | /api/reserves/</span>
        <div class="screen" style="margin-top:10px">
          <div class="screen-head"><span class="dot"></span><span class="dot"></span><span class="dot"></span> Planejamento</div>
          <div class="screen-body">
            <div class="item"><b>Internet</b><span>R$ 129,90</span></div>
            <div class="item"><span>Status</span><span class="status">Paga</span></div>
            <div class="item"><b>Aluguel</b><span>R$ 2.100,00</span></div>
            <div class="item"><span>Status</span><span class="status warn">Nao paga</span></div>
          </div>
        </div>
      </article>

      <article class="panel">
        <h2>Termometro de viagem</h2>
        <span class="pill">POST /api/trips/evaluate/</span>
        <p class="sub" style="margin:8px 0">Campos usados no backend: trip_total_cost, commitment_pct_balance, runway_days_after, risk_level e recommendation.</p>
        <div class="thermo"><div id="tripPin" class="pin"></div></div>
        <div class="mini-grid">
          <div class="mini"><span>Recomendacao</span><strong id="tripReco">Atenção</strong></div>
          <div class="mini"><span>Compromete saldo</span><strong id="tripCommit">0%</strong></div>
          <div class="mini"><span>Runway apos</span><strong id="tripRunway">0 dias</strong></div>
        </div>
      </article>
    </section>

    <div class="foot">GenFin • exemplos visuais reais do app</div>
  </div>

  <script>
    const fallback = {
      daily: { total_receita: 3500, total_despesa: 420, movimentacoes: 8, percent_receita: 89, percent_despesa: 11 },
      weekly: { total_receita: 7900, total_despesa: 1820, movimentacoes: 27, percent_receita: 81, percent_despesa: 19 },
      monthly: { total_receita: 15015.85, total_despesa: 486.45, movimentacoes: 36, percent_receita: 97, percent_despesa: 3 },
      categories: [
        { category: "Moradia", total: 2100 },
        { category: "Alimentacao", total: 890 },
        { category: "Transporte", total: 520 },
        { category: "Lazer", total: 280 },
        { category: "Saude", total: 170 }
      ],
      vehicle: {
        monthly_total: 1890.4,
        commute_monthly_cost: 612.2,
        vehicle_count: 2,
        by_category: [
          { category: "COMBUSTIVEL", total: 870.1 },
          { category: "MANUTENCAO", total: 310.0 },
          { category: "PEDAGIO", total: 180.0 },
          { category: "ESTACIONAMENTO", total: 132.1 },
          { category: "FINANCIAMENTO", total: 398.2 }
        ]
      },
      card: {
        card_count: 3,
        total_spent: 6212.85,
        total_limit: 6260.0,
        usage_percent: 99.2,
        estimated_points: 1147,
        usd_brl_rate: 5.42
      },
      trip: {
        recommendation: "Atenção",
        commitment_pct_balance: 18.4,
        runway_days_after: 84
      }
    };

    function brl(v){
      return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(v || 0));
    }
    async function getJson(url, fb){
      try{
        const r = await fetch(url, { credentials:"same-origin" });
        if(!r.ok) return fb;
        return await r.json();
      }catch(_e){
        return fb;
      }
    }
    function setText(id, value){
      const el = document.getElementById(id);
      if(el) el.textContent = value;
    }
    function periodTemplate(title, label, data){
      return `
      <div class="period-card">
        <div class="period-head"><span>${title}</span><span>${label}</span></div>
        <div class="line">
          <span>Receita</span>
          <div class="track"><div class="fill income" style="width:${Math.max(0,Math.min(100,Number(data.percent_receita||0)))}%"></div></div>
          <b>${Math.round(Number(data.percent_receita||0))}%</b>
        </div>
        <div class="line">
          <span>Despesa</span>
          <div class="track"><div class="fill expense" style="width:${Math.max(0,Math.min(100,Number(data.percent_despesa||0)))}%"></div></div>
          <b>${Math.round(Number(data.percent_despesa||0))}%</b>
        </div>
        <div class="mini-grid">
          <div class="mini"><span>Receita</span><strong>${brl(data.total_receita)}</strong></div>
          <div class="mini"><span>Despesa</span><strong>${brl(data.total_despesa)}</strong></div>
          <div class="mini"><span>Movimentacoes</span><strong>${Number(data.movimentacoes||0)}</strong></div>
        </div>
      </div>`;
    }
    function renderBars(containerId, rows){
      const box = document.getElementById(containerId);
      const list = (rows || []).slice(0,5);
      const max = Math.max(...list.map((i)=>Number(i.total || 0)), 1);
      box.innerHTML = list.map((item)=>{
        const pct = (Number(item.total || 0) / max) * 100;
        const name = String(item.category || "").slice(0,12);
        return `<div class="row"><span>${name}</span><div class="track"><div class="fill income" style="width:${pct}%"></div></div><strong>${brl(item.total)}</strong></div>`;
      }).join("");
    }

    async function init(){
      const [daily, weekly, monthly, categories, vehicle, card] = await Promise.all([
        getJson("/api/stats/daily/", fallback.daily),
        getJson("/api/stats/weekly/", fallback.weekly),
        getJson("/api/stats/monthly/", fallback.monthly),
        getJson("/api/dashboard/categories/", fallback.categories),
        getJson("/api/vehicles/summary/", fallback.vehicle),
        getJson("/api/credit-cards/summary/", fallback.card)
      ]);

      const saldo = Number(monthly.total_receita || 0) - Number(monthly.total_despesa || 0);
      const burn = Number(monthly.total_despesa || 0) / 10;
      const runway = burn > 0 ? Math.round(saldo / burn) : 0;
      const poupanca = Number(monthly.total_receita || 0) > 0
        ? Math.round((saldo / Number(monthly.total_receita || 0)) * 100)
        : 0;

      setText("heroReceita", brl(monthly.total_receita));
      setText("heroDespesa", brl(monthly.total_despesa));
      setText("heroSaldo", brl(saldo));
      setText("heroPoupanca", `${poupanca}%`);
      setText("heroBurn", brl(burn));
      setText("heroRunway", `${runway} dias`);

      document.getElementById("periodList").innerHTML = [
        periodTemplate("Diario", "/api/stats/daily/", daily),
        periodTemplate("Semanal", "/api/stats/weekly/", weekly),
        periodTemplate("Mensal", "/api/stats/monthly/", monthly)
      ].join("");

      const usage = Math.max(0, Math.min(100, Number(card.usage_percent || 0)));
      document.getElementById("cardDonut").style.setProperty("--pct", usage.toFixed(2));
      setText("cardPct", `${usage.toFixed(1)}%`);
      setText("cardUsed", brl(card.total_spent));
      setText("cardLimit", `de ${brl(card.total_limit)}`);
      setText("cardCount", Number(card.card_count || 0));
      setText("cardPoints", Math.round(Number(card.estimated_points || 0)));
      setText("cardUsd", card.usd_brl_rate ? Number(card.usd_brl_rate).toFixed(2) : "-");

      renderBars("categoryBars", categories);
      renderBars("vehicleBars", vehicle.by_category || fallback.vehicle.by_category);

      setText("vehicleMonthly", brl(vehicle.monthly_total));
      setText("vehicleCommute", brl(vehicle.commute_monthly_cost));
      setText("vehicleCount", Number(vehicle.vehicle_count || 0));

      const trip = fallback.trip;
      const pinPos = Math.max(5, Math.min(95, Number(trip.commitment_pct_balance || 0)));
      document.getElementById("tripPin").style.left = `${pinPos}%`;
      setText("tripReco", trip.recommendation);
      setText("tripCommit", `${Number(trip.commitment_pct_balance || 0).toFixed(1)}%`);
      setText("tripRunway", `${Number(trip.runway_days_after || 0).toFixed(0)} dias`);
    }
    init();
  </script>
</body>
</html>
